<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#00695C">
    <meta name="mobile-web-app-capable" content="yes">

    <title>Idle Socialist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Titan+One&family=Roboto:wght@500;700;900&display=swap');

        :root {
            --game-teal: #4DB6AC;
            --game-dark-teal: #00695C;
            --game-orange: #FF9800;
            --game-dark-orange: #E65100;
            --game-border: #263238;
            --card-bg: #80CBC4;
            --ring-fill: #FFD700;
            --ring-track: #004D40;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #B2DFDB;
            background-image: radial-gradient(#80CBC4 15%, transparent 16%), radial-gradient(#80CBC4 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative;
        }

        .city-skyline {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 45vh;
            background-repeat: repeat-x;
            background-size: cover;
            z-index: 0;
            pointer-events: none;
            opacity: 0.8;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 450' preserveAspectRatio='none'%3E%3Cpath fill='%23004D40' fill-opacity='0.15' d='M0,450V250h40v-80h30v80h20v-120h40v120h15v-60h35v60h25V100h50v150h20v-70h40v70h30V70h50v180h10v-50h40v50h20v-100h30v100h15v-70h35v70h20v-130h40v130h10V80h50v150h20v-60h30v60h20v-100h40v100h10v-50h30v50h20v-120h40v120h15v-80h35v80h25v-100h50v100h20v-60h40v60h30V110h50v110h10v-50h40v50h20v-90h30v90h15v-70h35v70h20v-140h40v140h10V90h50v140h20v-50h30v50h20v-80h40v80z'/%3E%3Cpath fill='%23004D40' fill-opacity='0.3' d='M0,450V300h30v-70h40v70h20v-100h50v100h10v-50h30v50h20v-80h40v80h25v-120h55v120h15v-60h35v60h30v-90h40v90h20v-70h50v70h10v-100h30v100h20v-60h40v60h25v-130h55v130h15v-50h35v50h30v-80h40v80h20v-100h50v100h10v-70h30v70h20v-90h40v90h25v-120h55v120h15v-60h35v60h30v-90h40v90h20v-100h50v100z'/%3E%3C/svg%3E");
        }

        .font-game { font-family: 'Titan One', cursive; }

        .btn-3d {
            transition: all 0.05s;
            border-bottom: 4px solid rgba(0,0,0,0.3);
        }
        .btn-3d:active {
            transform: translateY(3px);
            border-bottom: 1px solid rgba(0,0,0,0.3);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: var(--game-dark-teal); border-radius: 10px; }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }
        .floating-text {
            position: absolute;
            font-family: 'Titan One', cursive;
            color: #81C784;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            z-index: 100;
        }
        .floating-text-bad { color: #EF5350; }

        .manager-grayscale { filter: grayscale(100%) brightness(0.7); }

        .ring-container {
            position: relative;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--ring-track);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .icon-progress-ring {
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            z-index: 5;
            background: conic-gradient(var(--ring-fill) 0deg, transparent 0deg);
            -webkit-mask: radial-gradient(transparent 64%, black 65%);
            mask: radial-gradient(transparent 64%, black 65%);
        }
        
        .icon-inner {
            position: relative;
            z-index: 10;
            background-color: #004D40;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .multiplier-badge { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; }
        .badge-hidden { opacity: 0; transform: scale(0) rotate(-45deg); }
        .badge-visible { opacity: 1; transform: scale(1) rotate(0deg); }
        
        @keyframes lockExplode {
            0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
            40% { transform: translate(-50%, -50%) scale(3) rotate(15deg); opacity: 1; z-index: 100; }
            60% { transform: translate(-50%, -50%) scale(3.2) rotate(-15deg); opacity: 1; z-index: 100; }
            100% { transform: translate(-50%, -50%) scale(4) rotate(45deg); opacity: 0; z-index: 100; }
        }
        .lock-exploding {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%);
            animation: lockExplode 0.8s forwards ease-in-out;
            z-index: 9999 !important;
        }

        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg) scale(1.1); }
            50% { transform: rotate(10deg) scale(1.1); }
            75% { transform: rotate(-5deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }
        .animate-wiggle {
            animation: wiggle 0.4s ease-in-out infinite;
            box-shadow: 0 0 10px #FFD700;
        }
        
        @keyframes glow-only {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); border-color: #c2410c; }
            50% { box-shadow: 0 0 15px #FFD700; border-color: #FFD700; }
        }
        .animate-glow {
            animation: glow-only 1.5s infinite;
        }

        .flying-particle {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            transition: all 1.5s cubic-bezier(0.19, 1, 0.22, 1);
            font-size: 1.5rem;
        }
        
        .flying-bill {
            position: fixed;
            z-index: 9000;
            pointer-events: none;
            transition: all 0.8s ease-in;
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ade80;
            text-shadow: 1px 1px 0 #004D40;
        }
        
        .flying-badge {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            font-size: 0.7rem;
            font-weight: bold;
            background-color: #FACC15; /* Yellow-400 */
            color: black;
            padding: 2px 6px;
            border-radius: 999px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .context-toast {
            position: fixed;
            background-color: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 9999;
            pointer-events: none;
            animation: fadeUp 1s forwards;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .context-toast.success { background-color: rgba(34, 197, 94, 0.95); }
        .context-toast.info { background-color: rgba(59, 130, 246, 0.95); }
        
        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(0); }
            10% { opacity: 1; transform: translateY(-5px); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        @keyframes fadeUpLong {
            0% { opacity: 0; transform: translateY(0); }
            5% { opacity: 1; transform: translateY(-5px); }
            90% { opacity: 1; transform: translateY(-5px); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        /* Money Pulse Animation */
        .money-pulse {
            color: #4ade80 !important; /* Bright Green */
            transform: scale(1.15);
            transition: transform 0.1s ease-out, color 0.1s ease-out;
        }
        
        /* Transition back to normal */
        .money-normal {
            color: white;
            transform: scale(1);
            transition: transform 0.3s ease-in, color 0.3s ease-in;
        }

        /* Global Pulse for Boost Activation */
        @keyframes pulse-big {
            0% { transform: scale(1); color: white; }
            50% { transform: scale(1.3); color: #FACC15; text-shadow: 0 0 10px #FACC15; }
            100% { transform: scale(1); color: #FDE047; }
        }
        .animate-pulse-big {
            animation: pulse-big 0.5s ease-in-out;
        }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); }
        .progress-meter-fill { transition: width 0.5s ease-in-out; }

        .cursor-pointer-active { cursor: pointer; }
        .cursor-pointer-active:active { transform: scale(0.98); }
        
        /* REVOLUTION OVERLAY */
        #revolution-overlay {
            background: rgba(20, 20, 20, 0.95);
            z-index: 10000;
        }
        
        @keyframes runAcross {
            0% { transform: translateX(-300px); }
            100% { transform: translateX(120vw); }
        }
        
        @keyframes tilt {
            0% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
            100% { transform: rotate(-10deg); }
        }
        
        .runner-mayor {
            position: absolute;
            bottom: 30%;
            left: 0;
            width: 150px;
            animation: runAcross 4s linear forwards;
            z-index: 10002;
        }
        .runner-mayor img {
            width: 100%;
            animation: tilt 0.5s infinite ease-in-out;
        }
        
        .runner-mob {
            position: absolute;
            bottom: 30%;
            left: -300px; 
            width: 200px;
            animation: runAcross 4s linear forwards;
            animation-delay: 0.2s; 
            z-index: 10001;
        }
        .runner-mob img {
            width: 100%;
            animation: tilt 0.5s infinite ease-in-out;
            animation-delay: 0.25s;
        }
        
        /* MISSION BAR */
        .mission-card {
            background: #FEF3C7; /* Amber-100 */
            border: 2px solid #B45309; /* Amber-700 */
            border-radius: 8px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70px;
            position: relative;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .mission-card:active { transform: scale(0.95); }
        
        /* New Style for the Locked Ad Slot to match image */
        .mission-card-locked-ad {
            background: #F8FAFC; /* Slate-50 (White-ish) */
            border: 3px solid #9A3412; /* Orange-900/Brownish */
            border-radius: 12px;
        }

        .mission-locked { filter: grayscale(1); opacity: 0.7; pointer-events: none; }
        .mission-timer { 
            position: absolute; 
            top: 2px; 
            right: 2px;
            background: #B45309; 
            color: white; 
            font-size: 9px; 
            padding: 1px 4px; 
            border-radius: 4px; 
            font-weight: bold;
            z-index: 20;
        }
        .mission-icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        
        /* LEVEL LADDER */
        #level-ladder-overlay {
            /* Replaced gradient with Map + Overlay */
            background-color: #2c3e50;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 959 593'%3E%3Cpath fill='%23374151' d='M959 336l-6-23-28-15-14 4-6-10-27 3-28-21-12 16-19-10-30 8-11-7-24 23-10 24-12 3-13-13-34 11-4-14-27 9-16-8-32 9-17-5-30 23-3-12-22-11-20 24-33-11-20 14-22-11-33 26-50 10-16 21-36 15-30-1-11 13-12-9-38 26-46-13-34 10-19 35-28-7-17 23-24-3-20 13-20-6-26 21-5 26-25 12-31-8-13 27-17-6-38-18-9 2-20-12-15 7-44-18-18-33-19-10-10 16-12-2-26-23-44-23-13 4-21-14-10 13-10 34 22 6 22-11 19 18 3-26 5-24-24-11 17 26 12 40-8 34-14 12 15 21-14 18 6 27-18 21 10 32-4 23 18 24-12 16 13 20-5 25 22 16-17 35 24 20-1 23-11 40 22 6 28-9 12 8 21 2 15-10 19-1 34 37-5 24 14 31 2 20 30 4 8 22-8 21 3 13 18 12 16 37 4 7 16 24 18 4 22-17 25-14 22 9 11-11 31 1 30-18 13-35-7-18-22-28-13-27 23-9 21-22 25 8 21 22-11 47-8 14-15 10-42 16-20 50-8 22-12 18 3 22-10 47 6 12-19 28-6 18 12 13-8 16 8 28-16 18-27 21-3 24-15 27-7 8-17-4-26 15-18-22-34 8-14-15z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 9999;
            overflow: hidden; /* Prevent scrolling */
            /* Add dark overlay effect */
            box-shadow: inset 0 0 0 1000px rgba(0,0,0,0.5);
        }
        .ladder-container {
            width: 160px;
            height: 75vh; /* Take up 75% of viewport height to spread boxes evenly */
            background: transparent;
            border: none;
            position: relative;
            margin: 0;
            display: flex;
            /* Stack bottom to top */
            flex-direction: column-reverse; 
            justify-content: space-between; /* Evenly distribute the 5 boxes */
            padding: 20px 0;
        }
        
        /* The Infinite Road Line */
        .ladder-container::before {
            content: '';
            position: absolute;
            top: -10vh; 
            bottom: -10vh; 
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            background-color: rgba(255, 255, 255, 0.3);
            border-left: 2px solid rgba(255,255,255,0.5);
            border-right: 2px solid rgba(255,255,255,0.5);
            border-radius: 8px;
            z-index: 0;
        }

        .ladder-step {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Updated Purple Styling */
            background-color: #9333ea; /* Purple-600 */
            border: 3px solid #d8b4fe; /* Light Purple Border */
            border-radius: 30px; /* Pill shape */
            box-shadow: 0 4px 0 #6b21a8; /* Dark Purple Shadow */
            
            font-family: 'Titan One', cursive;
            color: white; /* White Text */
            font-size: 1.5rem;
            position: relative;
            /* Default Z-index */
            z-index: 1; 
            flex-shrink: 0; /* Prevent squishing */
        }
        
        /* High Z-index for the active step so avatar climbs ON TOP of next box */
        .ladder-step.active-step {
            z-index: 10;
        }

        .ladder-avatar {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 80px; /* Increased from 50px */
            height: 80px; /* Increased from 50px */
            border-radius: 50%;
            border: 4px solid #FACC15; /* Slightly thicker border */
            background: white;
            overflow: hidden;
            transition: bottom 1s ease-in-out;
            z-index: 20;
            bottom: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        /* ACTIVE BOOST STYLE */
        .boost-active {
            color: #FACC15 !important;
            border-color: #FACC15 !important;
        }
        
        /* RED TIP */
        .notification-dot {
            position: absolute;
            top: -4px;
            right: 8px;
            width: 12px;
            height: 12px;
            background-color: #EF4444;
            border-radius: 50%;
            border: 2px solid #004D40;
        }
        
        /* SPINNER */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* STIMULUS CHECK OVERLAY */
        #stimulus-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100; /* Above missions */
            overflow: hidden;
            pointer-events: none; /* Let clicks pass unless clicking the flyer */
        }
        
        .flyer-bill {
            position: absolute;
            top: 10px;
            left: -80px;
            width: 60px;
            height: 30px;
            background: #22c55e; /* Green-500 */
            border: 2px solid #14532d; /* Green-900 */
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #bbf7d0; /* Green-200 */
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            pointer-events: auto;
            cursor: pointer;
            animation: bounceFly 0.8s infinite ease-in-out, flyAcross 8s linear forwards;
        }
        /* Wings */
        .flyer-bill::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 5px;
            width: 15px;
            height: 10px;
            background: white;
            border-radius: 50% 50% 0 0;
            transform: rotate(-20deg);
            animation: flapLeft 0.2s infinite alternate;
        }
        .flyer-bill::after {
            content: '';
            position: absolute;
            top: -10px;
            right: 5px;
            width: 15px;
            height: 10px;
            background: white;
            border-radius: 50% 50% 0 0;
            transform: rotate(20deg);
            animation: flapRight 0.2s infinite alternate;
        }
        
        @keyframes flyAcross {
            0% { left: -80px; top: 5px; }
            100% { left: 120%; top: 50px; } /* Moves closer to bottom edge */
        }
        @keyframes bounceFly {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes flapLeft {
            from { transform: rotate(-20deg) translateY(0); }
            to { transform: rotate(-40deg) translateY(-5px); }
        }
        @keyframes flapRight {
            from { transform: rotate(20deg) translateY(0); }
            to { transform: rotate(40deg) translateY(-5px); }
        }
        /* MANAGER UPGRADE ANIMATION */
.upgrade-overlay-container {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 99999; /* Above everything */
    display: flex;
    align-items: center;
    justify-content: center;
}

.flying-manager-icon {
    position: fixed;
    z-index: 100000;
    border-radius: 50%;
    border: 4px solid #FACC15; /* Gold border */
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.upgrade-text-box {
    position: absolute;
    top: 60%; /* Below the centered icon */
    background: rgba(0,0,0,0.8);
    border: 2px solid #FACC15;
    border-radius: 15px;
    padding: 10px 20px;
    text-align: center;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.3s ease-out;
    z-index: 100001;
}

.upgrade-text-box.visible {
    opacity: 1;
    transform: scale(1);
}

.upgrade-label {
    color: #FFF;
    font-size: 12px;
    text-transform: uppercase;
    font-weight: bold;
    font-family: sans-serif;
}

.upgrade-value {
    font-family: 'Titan One', cursive;
    color: #FACC15;
    font-size: 32px;
    text-shadow: 0 2px 0 #000;
}
/* ... existing styles ... */

/* NEW ANIMATIONS FOR MISSION LOCK */
@keyframes lockShake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(10deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-10deg); }
    100% { transform: rotate(0deg); }
}
@keyframes lockOpen {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.8; }
    100% { transform: scale(2); opacity: 0; }
}

.animate-lock-shake {
    animation: lockShake 0.3s infinite ease-in-out;
    color: #FACC15 !important; /* Turn Gold */
}
.animate-lock-open {
    animation: lockOpen 0.5s forwards ease-out;
}
    </style>
</head>
<body class="h-screen flex flex-col text-gray-900">

    <div class="city-skyline"></div>

    <header class="bg-teal-800 border-b-4 border-teal-900 p-2 z-20 shadow-xl relative">
        <div class="max-w-md mx-auto flex justify-between items-center relative">
            
            <div class="relative group cursor-pointer" onclick="game.openProfileModal()">
                <div class="w-16 h-16 rounded-full border-4 border-white shadow-lg overflow-hidden bg-yellow-300 relative z-10 avatar-container hover:scale-105 transition-transform">
                    <img id="avatar-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23FDD835'/%3E%3Ccircle cx='100' cy='100' r='80' fill='%238D5524'/%3E%3Cpath d='M50,80 Q100,20 150,80 L150,120 Q100,180 50,120 Z' fill='%238D5524'/%3E%3Cpath d='M40,80 Q100,-20 160,80 L160,100 L40,100 Z' fill='%231a1a1a'/%3E%3Crect x='50' y='140' width='100' height='60' fill='%23333' rx='20'/%3E%3Cpath d='M90,140 L110,140 L110,200 L90,200 Z' fill='%23FFFFFF'/%3E%3Ccircle cx='75' cy='100' r='8' fill='%23000000'/%3E%3Ccircle cx='125' cy='100' r='8' fill='%23000000'/%3E%3Cpath d='M70,120 Q100,140 130,120' stroke='%23000000' stroke-width='4' fill='none'/%3E%3Cpath d='M60,120 L140,120 L140,150 Q100,180 60,150 Z' fill='%231a1a1a'/%3E%3Cpath d='M55,90 L95,90' stroke='%231a1a1a' stroke-width='3'/%3E%3Cpath d='M105,90 L145,90' stroke='%231a1a1a' stroke-width='3'/%3E%3C/svg%3E" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-30 opacity-0 group-hover:opacity-100 flex items-center justify-center transition">
                        <i class="fas fa-pen text-white"></i>
                    </div>
                </div>
                <div class="absolute -bottom-2 -right-2 bg-orange-500 text-white text-xs font-bold px-2 py-0.5 rounded-full border-2 border-white z-20" id="level-badge">LVL 1</div>
            </div>

            <div class="flex-1 mx-2 flex flex-col gap-1">
                <div class="flex gap-1">
                    <div class="bg-teal-900 rounded-full p-1 border-2 border-teal-600 flex-1 h-8 flex items-center justify-center" id="money-container">
                        <div class="text-center text-white font-game text-sm tracking-wide leading-none money-normal" id="money-text">
                            <span class="text-green-400 mr-1">$</span><span id="influence-display">0</span>
                            <span id="boost-badge" class="hidden text-[9px] bg-yellow-400 text-black px-1 rounded ml-1 animate-pulse">x2</span>
                        </div>
                    </div>
                    <div id="theory-counter-target" class="bg-blue-900 rounded-full p-1 border-2 border-blue-600 w-16 h-8 flex items-center justify-center cursor-pointer active:scale-95 transition" title="Theory Points">
                        <div class="text-center text-white font-game text-sm tracking-wide leading-none">
                            <span class="text-blue-300 mr-1">üìò</span><span id="theory-display">0</span>
                        </div>
                    </div>
                </div>
                <div class="bg-red-900 rounded-full p-1 border-2 border-red-700 relative shadow-inner h-6 overflow-hidden">
                    <div class="absolute top-0 left-0 h-full bg-red-600 progress-meter-fill" id="unhappiness-bar" style="width: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-red-100 text-[9px] font-bold relative z-10">
                        <span class="mr-1">üò†</span> <span id="unhappiness-display">0</span> / <span id="unhappiness-limit">100k</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-1">
                <button onclick="game.showPrestigeModal()" class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-2 py-1 rounded border-b-2 border-purple-800 active:translate-y-1">ADVANCE</button>
                <button onclick="game.hardReset()" class="bg-red-600 hover:bg-red-500 text-white text-xs font-bold px-2 py-1 rounded border-b-2 border-red-800 active:translate-y-1">RESET</button>
            </div>
        </div>
    </header>

    <div class="bg-teal-700 w-full z-10 shadow-md relative border-b-4 border-teal-800">
        <div id="mission-container" class="max-w-md mx-auto grid grid-cols-3 gap-2 p-2 relative z-10"></div>
        
        <div id="stimulus-overlay" class="hidden">
            <div id="stimulus-flyer" class="flyer-bill" onclick="game.openStimulusModal(event)">
                <i class="fas fa-money-bill-wave"></i>
            </div>
        </div>
    </div>

    <main class="flex-1 overflow-y-auto relative pb-24 pt-4 px-2 z-10" id="scroll-container">
        <div class="max-w-md mx-auto space-y-3" id="generator-container"></div>
    </main>

    <nav class="bg-teal-800 border-t-4 border-teal-900 p-2 fixed bottom-0 w-full z-30 shadow-2xl">
        <div class="max-w-md mx-auto flex justify-around">
            <button class="flex flex-col items-center text-white opacity-100 scale-110 transition">
                <i class="fas fa-industry text-2xl mb-1 text-yellow-400 drop-shadow-md"></i>
                <span class="text-[10px] font-bold uppercase">Production</span>
            </button>
            <button class="flex flex-col items-center text-teal-300 hover:text-white transition relative" onclick="game.openAllRepsModal()">
                <i class="fas fa-user-tie text-2xl mb-1 drop-shadow-md"></i>
                <span class="text-[10px] font-bold uppercase">Reps</span>
                <div id="rep-notification" class="notification-dot hidden"></div>
            </button>
            <button class="flex flex-col items-center text-teal-300 hover:text-white transition" onclick="game.openPropertiesModal()">
                <i class="fas fa-home text-2xl mb-1 drop-shadow-md"></i>
                <span class="text-[10px] font-bold uppercase">Properties</span>
            </button>
            <button class="flex flex-col items-center text-teal-300 hover:text-white transition" onclick="game.manualClick({clientX: window.innerWidth/2, clientY: window.innerHeight/2})">
                <i class="fas fa-bullhorn text-2xl mb-1 drop-shadow-md"></i>
                <span class="text-[10px] font-bold uppercase">Fundraise</span>
            </button>
            <button id="ad-boost-btn" class="flex flex-col items-center text-teal-300 hover:text-white transition" onclick="game.watchAd('boost')">
                <i class="fas fa-tv text-2xl mb-1 drop-shadow-md"></i>
                <span class="text-[10px] font-bold uppercase" id="ad-boost-text">Boost</span>
            </button>
        </div>
    </nav>

    <div id="ad-modal" class="fixed inset-0 bg-black z-50 hidden flex items-center justify-center">
        <div class="text-center w-64">
            <div class="spinner mx-auto mb-4"></div>
            <div class="text-white font-bold text-lg">Watching Ad...</div>
            <div class="w-full bg-gray-700 h-2 rounded-full mt-3 overflow-hidden">
                <div id="ad-progress-bar" class="h-full bg-green-500 w-0 transition-all duration-300 ease-linear"></div>
            </div>
            <div class="text-gray-400 text-xs mt-2" id="ad-timer-text">Please wait 3s...</div>
        </div>
    </div>

    <div id="stimulus-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center px-4">
        <div class="bg-blue-900 rounded-xl shadow-2xl w-full max-w-sm overflow-hidden border-4 border-yellow-400 animate-bounce-in text-center relative">
            <div class="p-6 text-white relative">
                <button onclick="game.closeStimulusModal()" class="absolute top-2 right-2 text-blue-300 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                
                <div class="mb-4 flex justify-center">
                    <div class="w-20 h-20 rounded-full border-4 border-white overflow-hidden bg-gray-300">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Senator" class="w-full h-full object-cover">
                    </div>
                </div>
                
                <h2 class="font-game text-xl mb-1 uppercase text-yellow-300 leading-tight">Senator Spend</h2>
                <p class="text-sm mb-4 text-blue-100 italic">"A stimulus package for the people!"</p>
                
                <div class="bg-blue-800 rounded p-3 mb-4 border border-blue-600">
                    <div class="text-xs uppercase text-blue-300">Stimulus Amount</div>
                    <div class="text-2xl font-bold text-green-400" id="stimulus-amount-display">$0</div>
                    <div class="text-[10px] text-blue-200">Equal to 60s of production</div>
                </div>
                
                <button onclick="game.watchStimulusAd()" class="w-full bg-green-600 hover:bg-green-500 text-white font-black text-lg py-3 rounded shadow-[0_4px_0_rgb(21,128,61)] active:translate-y-1 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-tv"></i> ACCEPT CHECK
                </button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center px-4">
        <div class="bg-teal-800 rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-bounce-in border-4 border-teal-900 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b-4 border-teal-900 flex justify-between items-center bg-teal-800 shrink-0">
                <h2 class="text-white font-game text-xl">Player Profile</h2>
                <button onclick="game.closeModal('profile-modal')" class="text-teal-200 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-4 bg-teal-50 overflow-y-auto flex-1">
                <div class="mb-6">
                    <label class="block text-teal-900 font-bold text-xs uppercase mb-1">Revolutionary Name</label>
                    <div class="flex gap-2">
                        <input type="text" id="player-name-input" class="flex-1 bg-white border-2 border-teal-300 rounded px-3 py-2 font-bold text-gray-800 focus:border-teal-600 outline-none shadow-inner" placeholder="Enter Name">
                        <button onclick="game.saveProfileName()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold text-xs shadow-[0_3px_0_rgb(21,128,61)] active:translate-y-0.5 active:shadow-none transition-all">SAVE</button>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-teal-900 font-bold text-xs uppercase mb-2">Choose Your Look</label>
                    <div class="grid grid-cols-3 gap-3" id="avatar-grid">
                        </div>
                </div>

                <div>
                    <label class="block text-teal-900 font-bold text-xs uppercase mb-2">Career Stats</label>
                    <div class="bg-white rounded-lg border-2 border-teal-200 p-3 space-y-2 text-xs shadow-sm">
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1"><span class="text-gray-500 font-bold">Fundraise Taps</span> <span class="font-black text-teal-800 text-sm" id="stat-taps">0</span></div>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1"><span class="text-gray-500 font-bold">Upgrades Bought</span> <span class="font-black text-teal-800 text-sm" id="stat-upgrades">0</span></div>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1"><span class="text-gray-500 font-bold">Managers Hired</span> <span class="font-black text-teal-800 text-sm" id="stat-managers">0</span></div>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1"><span class="text-gray-500 font-bold">Managers Promoted</span> <span class="font-black text-teal-800 text-sm" id="stat-mgr-upgrades">0</span></div>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1"><span class="text-gray-500 font-bold">Quests Completed</span> <span class="font-black text-teal-800 text-sm" id="stat-quests">0</span></div>
                        <div class="flex justify-between items-center pt-1"><span class="text-gray-500 font-bold">Max Cash Held</span> <span class="font-black text-green-600 text-sm" id="stat-max-cash">$0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="properties-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-bounce-in flex flex-col max-h-[80vh]">
            <div class="bg-teal-800 p-4 flex justify-between items-center border-b-4 border-teal-900 shrink-0">
                <h2 class="text-white font-game text-lg">Real Estate</h2>
                <button onclick="game.closeModal('properties-modal')" class="text-teal-200 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="bg-teal-100 p-3 text-xs text-teal-900 text-center border-b border-teal-200 font-bold">
                <i class="fas fa-info-circle mr-1"></i> Buy Properties to show your influence!
            </div>
            <div class="p-4 bg-teal-50 overflow-y-auto flex-1" id="properties-list">
                </div>
        </div>
    </div>

    <div id="manager-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-bounce-in">
            <div class="bg-teal-800 p-4 flex justify-between items-center border-b-4 border-teal-900">
                <h2 class="text-white font-game text-lg">Select Union Rep</h2>
                <button onclick="game.closeModal('manager-modal')" class="text-teal-200 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="bg-teal-100 p-3 text-xs text-teal-900 text-center border-b border-teal-200 font-bold">
                <i class="fas fa-info-circle mr-1"></i> Hire a Rep to AUTOMATE this business!
            </div>
            <div class="p-4 bg-teal-50 max-h-[60vh] overflow-y-auto" id="modal-list"></div>
        </div>
    </div>
    
    <div id="all-reps-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-bounce-in flex flex-col max-h-[80vh]">
            <div class="bg-teal-800 p-4 flex justify-between items-center border-b-4 border-teal-900 shrink-0">
                <h2 class="text-white font-game text-lg">Union Reps & Theory</h2>
                <div class="flex items-center gap-2">
                    <span class="text-white text-sm bg-blue-700 px-2 py-1 rounded border border-blue-500">üìò <span id="modal-theory-display">0</span></span>
                    <button onclick="game.closeModal('all-reps-modal')" class="text-teal-200 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                </div>
            </div>
            <div class="p-4 bg-teal-50 overflow-y-auto flex-1" id="all-reps-list"></div>
        </div>
    </div>

    <div id="level-ladder-overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center">
        <div class="text-white font-game text-2xl mb-4 drop-shadow-md mt-10 relative z-10">ADVANCING...</div>
        <div class="w-full flex-1 overflow-hidden flex justify-center relative z-10">
             <div class="ladder-container flex flex-col-reverse" id="ladder-steps">
                </div>
        </div>
    </div>

    <div id="prestige-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center px-4">
        <div class="bg-red-900 rounded-xl shadow-2xl w-full max-w-sm overflow-hidden border-4 border-yellow-500 animate-bounce-in text-center">
            <div class="p-6 bg-red-800 text-white relative">
                <button onclick="game.closePrestigeModal()" class="absolute top-2 right-2 text-red-300 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                
                <i class="fas fa-fist-raised text-6xl text-yellow-400 mb-4 animate-pulse"></i>
                <h2 class="font-game text-xl mb-2 uppercase text-yellow-300 leading-tight">The People Are Too Unhappy. Time to move to another city?</h2>
                <p class="text-sm mb-4 text-red-100">Reset your progress to gain prestige multipliers!</p>
                <div class="bg-red-950 rounded p-3 mb-4 border border-red-600">
                    <div class="text-xs uppercase text-red-300">Next Stage Bonus</div>
                    <div class="text-2xl font-bold text-green-400" id="prestige-bonus-display">Production x2</div>
                </div>
                <button onclick="game.startPrestigeSequence()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-red-900 font-black text-lg py-3 rounded shadow-[0_4px_0_rgb(180,83,9)] active:translate-y-1 transition-all">
                    ADVANCE TO LEVEL <span id="next-level-display">2</span>
                </button>
            </div>
        </div>
    </div>

    <div id="revolution-overlay" class="fixed inset-0 hidden">
        <div class="relative w-full h-full overflow-hidden">
            <div id="mayor-runner" class="runner-mayor">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cg%3E%3Cpath d='M60,180 L50,200 M140,180 L150,200' stroke='black' stroke-width='8'/%3E%3Crect x='60' y='80' width='80' height='100' fill='%23333' rx='10'/%3E%3Crect x='80' y='80' width='40' height='100' fill='white'/%3E%3Cpath d='M100,90 L100,180' stroke='%23ddd' stroke-width='1'/%3E%3Ccircle cx='100' cy='60' r='30' fill='%23ffe0bd'/%3E%3Crect x='60' y='20' width='80' height='40' fill='black'/%3E%3Crect x='50' y='60' width='100' height='10' fill='black'/%3E%3Ccircle cx='90' cy='55' r='3' fill='black'/%3E%3Ccircle cx='110' cy='55' r='3' fill='black'/%3E%3Cpath d='M90,70 Q100,60 110,70' stroke='black' fill='none' stroke-width='2'/%3E%3Crect x='10' y='100' width='60' height='50' rx='10' fill='%234CAF50' stroke='black' stroke-width='2'/%3E%3Ctext x='25' y='135' font-family='sans-serif' font-size='30' fill='white' font-weight='bold'%3E$%3C/text%3E%3C/g%3E%3C/svg%3E" alt="Running Mayor">
            </div>
            <div id="mob-runner" class="runner-mob">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 200'%3E%3Cg%3E%3Cg transform='translate(50,0)'%3E%3Ccircle cx='50' cy='50' r='20' fill='%23ffe0bd'/%3E%3Crect x='30' y='70' width='40' height='60' fill='%23D32F2F'/%3E%3Cpath d='M20,100 L10,60 L10,20' stroke='brown' stroke-width='4'/%3E%3Cpath d='M10,20 L0,10 M10,20 L20,10' stroke='silver' stroke-width='3'/%3E%3C/g%3E%3Cg transform='translate(150,10)'%3E%3Ccircle cx='50' cy='50' r='20' fill='%238d5524'/%3E%3Crect x='30' y='70' width='40' height='60' fill='%231976D2'/%3E%3Crect x='80' y='40' width='5' height='80' fill='brown'/%3E%3Crect x='70' y='20' width='25' height='20' fill='white' stroke='black'/%3E%3C/g%3E%3C/svg%3E" alt="Angry Mob">
            </div>
            <div class="absolute top-1/4 w-full text-center">
                <h1 class="font-game text-4xl text-yellow-400 text-stroke animate-pulse">REVOLUTION!</h1>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 flex flex-col gap-2 pointer-events-none z-50 w-full max-w-xs px-4"></div>

    <template id="generator-template">
        <div class="bg-teal-700 rounded-xl p-2 shadow-[0_4px_0_rgba(0,0,0,0.2)] border-2 border-teal-900 relative overflow-hidden group">
            <div class="flex items-center gap-2 mb-2 manual-trigger-area">
                <div class="ring-container flex-shrink-0">
                    <div class="icon-progress-ring"></div>
                    <div class="icon-inner shadow-inner"><span class="emoji text-3xl">ü•ï</span></div>
                    <div class="absolute -bottom-1 -right-1 bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded border border-white z-20 shadow-sm"><span class="count">0</span></div>
                    <div class="absolute -top-2 -left-2 bg-yellow-400 text-black text-[10px] font-black px-1.5 py-0.5 rounded-full border border-white z-30 shadow-sm badge-hidden multiplier-badge pointer-events-none">x2</div>
                </div>
                <div class="flex-1 min-w-0 pl-1">
                    <div class="flex justify-between items-end mb-1">
                        <h3 class="font-bold text-white text-sm truncate name text-shadow-sm">Garden</h3>
                        <div class="text-right">
                            <div class="text-xs text-yellow-300 font-mono font-bold revenue">$0</div>
                            <div class="text-[10px] text-red-300 font-bold unhappiness-gen flex items-center justify-end gap-1 opacity-80"><span>+0</span> <span class="text-[8px]">üò†</span></div>
                        </div>
                    </div>
                    <div class="h-6 bg-teal-900 rounded-full border-2 border-teal-600 relative overflow-hidden">
                        <div class="progress-fill bg-gradient-to-r from-green-400 to-green-500 h-full w-0 absolute top-0 left-0 border-r-2 border-green-300"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md timer-text z-10">00:00:00</div>
                    </div>
                    <div class="text-[9px] text-teal-200 text-right mt-0.5 pr-1 next-bonus-text">Next x2 at 10</div>
                </div>
                <div class="flex-shrink-0 relative">
                    <button class="manager-btn w-14 h-14 rounded-full bg-yellow-100 border-4 border-gray-400 overflow-hidden hover:scale-105 active:scale-95 transition relative manager-grayscale shadow-md">
                        <img src="" class="w-full h-full object-cover manager-img">
                        <div class="manager-lock absolute inset-0 flex items-center justify-center bg-black bg-opacity-50"><i class="fas fa-lock text-white text-xs"></i></div>
                    </button>
                    <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 bg-gray-700 text-white text-[8px] px-1 rounded whitespace-nowrap border border-gray-500 z-20 manager-label shadow-sm">Hire</div>
                </div>
            </div>
            <button class="buy-btn btn-3d w-full bg-orange-500 hover:bg-orange-400 text-white font-bold py-2 px-4 rounded-lg border-b-4 border-orange-700 flex items-center justify-between text-sm disabled:opacity-50 disabled:cursor-not-allowed disabled:border-none disabled:translate-y-1 select-none">
                <span class="uppercase text-[10px] tracking-wider opacity-90">Buy x1</span>
                <span class="flex items-center gap-1 text-lg font-game text-stroke cost">$15</span>
            </button>
        </div>
    </template>

    <script>
        const GENERATORS_DATA = [
            { id: "taxes", name: "Tax Collection", icon: "üí∞", baseCost: 15, baseRevenue: 1, baseUnhappiness: 1, cycleTime: 600 },
            { id: "social_union", name: "Social Studies Union", icon: "üìö", baseCost: 100, baseRevenue: 10, baseUnhappiness: 10, cycleTime: 3000 },
            { id: "zamdani_care", name: "Zamdani Care", icon: "üè•", baseCost: 1100, baseRevenue: 80, baseUnhappiness: 100, cycleTime: 6000 },
            { id: "foodstores", name: "State Foodstores", icon: "ü•´", baseCost: 12000, baseRevenue: 470, baseUnhappiness: 1000, cycleTime: 12000 },
            { id: "homeless_transit", name: "Homeless Transit", icon: "üöå", baseCost: 130000, baseRevenue: 2600, baseUnhappiness: 10000, cycleTime: 24000 },
            { id: "friendship_grid", name: "Friendship Grid", icon: "‚ö°", baseCost: 1400000, baseRevenue: 14000, baseUnhappiness: 100000, cycleTime: 96000 },
            { id: "rent_control", name: "Rent Control", icon: "üè†", baseCost: 20000000, baseRevenue: 100000, baseUnhappiness: 1000000, cycleTime: 384000 }
        ];

        // UPDATED MANAGER OPTIONS WITH RARITY
        // Green = common, Blue = rare, Orange = legendary
        const MANAGER_OPTIONS = {
            "taxes": [
                { id: "taxes_1", name: "Auditor Andy", rarity: "common", cost: 500, mult: 2, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Andy" }, 
                { id: "taxes_2", name: "Taxman Ted", rarity: "rare", cost: 5000, mult: 10, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Ted" }, 
                { id: "taxes_3", name: "Comptroller Cat", rarity: "legendary", cost: 50000, mult: 50, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Cat" }
            ],
            "social_union": [
                { id: "union_1", name: "Tutor Tim", rarity: "common", cost: 10000, mult: 2, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Tim" }, 
                { id: "union_2", name: "Prof. Pat", rarity: "rare", cost: 100000, mult: 10, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Pat" }, 
                { id: "union_3", name: "Dean Dan", rarity: "legendary", cost: 1000000, mult: 50, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Dan" }
            ],
            "zamdani_care": [
                { id: "care_1", name: "Nurse Nancy", rarity: "common", cost: 50000, mult: 2, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Nancy" }, 
                { id: "care_2", name: "Dr. Dave", rarity: "rare", cost: 500000, mult: 10, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Dave" }, 
                { id: "care_3", name: "Surgeon Sarah", rarity: "legendary", cost: 5000000, mult: 50, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah" }
            ],
            "foodstores": [
                { id: "food_1", name: "Stocker Sam", rarity: "common", cost: 200000, mult: 2, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sam" }, 
                { id: "food_2", name: "Manager Mike", rarity: "rare", cost: 2000000, mult: 10, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Mike" }, 
                { id: "food_3", name: "Director Deb", rarity: "legendary", cost: 20000000, mult: 50, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Deb" }
            ],
            "homeless_transit": [
                { id: "transit_1", name: "Trainee Tom", rarity: "common", cost: 1000000, mult: 2, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Tom" }, 
                { id: "transit_2", name: "Driver Dan", rarity: "rare", cost: 10000000, mult: 10, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Dan" }, 
                { id: "transit_3", name: "Pilot Pete", rarity: "legendary", cost: 100000000, mult: 50, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Pete" }
            ],
            "friendship_grid": [
                { id: "energy_1", name: "Sparky Sam", rarity: "common", cost: 5000000, mult: 2, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sam" }, 
                { id: "energy_2", name: "Tech Tina", rarity: "rare", cost: 50000000, mult: 10, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Tina" }, 
                { id: "energy_3", name: "Eng. Earl", rarity: "legendary", cost: 500000000, mult: 50, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Earl" }
            ],
            "rent_control": [
                { id: "housing_1", name: "Inspector Ivy", rarity: "common", cost: 20000000, mult: 2, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Ivy" }, 
                { id: "housing_2", name: "Planner Paul", rarity: "rare", cost: 200000000, mult: 10, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Paul" }, 
                { id: "housing_3", name: "Director Don", rarity: "legendary", cost: 2000000000, mult: 50, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Don" }
            ]
        };

        const PROPERTIES_DATA = [
            { id: "studio", name: "Studio Apartment", icon: "üõãÔ∏è", cost: 50000, desc: "A humble beginning for a leader." },
            { id: "apt1", name: "1 Bedroom Apt", icon: "üè¢", cost: 10000000, desc: "A respectable base of operations." },
            { id: "apt2", name: "2 Bedroom Apt", icon: "üåá", cost: 5000000000, desc: "Room for committees." }, // 5B
            { id: "townhouse", name: "Townhouse", icon: "üèòÔ∏è", cost: 2000000000000, desc: "Three floors of power." }, // 2T
            { id: "house", name: "Detached House", icon: "üè°", cost: 1000000000000000, desc: "A suburban fortress." }, // 1 Quadrillion
            { id: "vacation", name: "Vacation Home", icon: "üèñÔ∏è", cost: 500000000000000000000, desc: "Rest is revolutionary." }, // 500 Qi
            { id: "villa", name: "Luxury Villa", icon: "üè∞", cost: 250000000000000000000000, desc: "For diplomatic summits." }, // 250 Sx
            { id: "mansion", name: "Mega Mansion", icon: "üèüÔ∏è", cost: 100000000000000000000000000, desc: "The people's palace." }, // 100 Sp
            { id: "island", name: "Tropical Island", icon: "üèùÔ∏è", cost: 50000000000000000000000000000, desc: "A nation unto itself." } // 50 Oc
        ];

        const AVATAR_PRESETS = [
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Calvin",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Dwight",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Eliza",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Frank",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Grace",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Henry"
        ];

        function formatNumber(num) {
            if (num >= 1e27) return "$" + (num / 1e27).toFixed(2) + "Oc";
            if (num >= 1e24) return "$" + (num / 1e24).toFixed(2) + "Sp";
            if (num >= 1e21) return "$" + (num / 1e21).toFixed(2) + "Sx";
            if (num >= 1e18) return "$" + (num / 1e18).toFixed(2) + "Qi";
            if (num >= 1e15) return "$" + (num / 1e15).toFixed(2) + "Q";
            if (num >= 1e12) return "$" + (num / 1e12).toFixed(2) + "T";
            if (num >= 1e9) return "$" + (num / 1e9).toFixed(2) + "B";
            if (num >= 1e6) return "$" + (num / 1e6).toFixed(2) + "M";
            if (num >= 1e3) return "$" + (num / 1e3).toFixed(2) + "k";
            return "$" + Math.floor(num).toLocaleString();
        }
        function formatUnhappiness(num) {
             if (num >= 1e12) return (num / 1e12).toFixed(2) + "T";
            if (num >= 1e9) return (num / 1e9).toFixed(2) + "B";
            if (num >= 1e6) return (num / 1e6).toFixed(2) + "M";
            if (num >= 1e3) return (num / 1e3).toFixed(2) + "k";
            return Math.floor(num).toLocaleString();
        }
        function formatTime(ms) {
            if (ms < 1000) return (ms/1000).toFixed(1) + "s";
            let totalSec = Math.ceil(ms / 1000);
            let m = Math.floor(totalSec / 60);
            let s = totalSec % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        class Game {
            constructor() {
                this.state = {
                    influence: 0,
                    unhappiness: 0,
                    theoryPoints: 0, 
                    level: 1,
                    prestigeMultiplier: 1,
                    lifetime: 0,
                    generators: {},
                    activeManagers: {},
                    managerLevels: {}, 
                    progress: {},
                    customAvatar: null, 
                    activeMissions: {}, 
                    missionTimers: {}, 
                    missionCooldowns: {},
                    adBoostExpiry: 0,
                    missionCount: 0,
                    adSlotUnlocked: false,
                    playerName: "",
                    ownedProperties: [],
                    stats: {
                        taps: 0,
                        upgrades: 0,
                        managersHired: 0,
                        managersUpgraded: 0,
                        quests: 0,
                        maxCash: 0
                    },
                    // New Stimulus Check State
                    lastStimulusTime: Date.now(),
                    stimulusActive: false
                };
                this.affordableTrackers = {};
                this.manualUsageTrackers = {}; 
                this.buyButtonPulseTrackers = {}; 
                this.midSlotUnlocking = false;
                this.buyInterval = null;
                this.moneyPulseTimeout = null;
                this.stimulusAnimationTimeout = null;
                
                GENERATORS_DATA.forEach(g => {
                    this.state.generators[g.id] = 0;
                    this.state.progress[g.id] = 0;
                    this.state.activeManagers[g.id] = null;
                });
                Object.values(MANAGER_OPTIONS).flat().forEach(m => {
                    this.state.managerLevels[m.id] = 1;
                });

                this.lastTick = Date.now();
                this.prestigePending = false;
                this.missionConfig = {
                    midSlotUnlockTime: 90000, 
                    midSlotDuration: 60000, 
                    midSlotCooldown: 60000 
                };
                this.levelStartTime = Date.now();
            }

            // --- HELPER METHODS MOVED TO TOP TO ENSURE AVAILABILITY ---
            getGenCost(id) { 
                const g = GENERATORS_DATA.find(x => x.id === id);
                if (id === 'taxes' && Number(this.state.generators[id]) === 0) return 0;
                return Math.floor(g.baseCost * Math.pow(1.15, this.state.generators[id]));
            }
            
            getGenMultiplier(id) {
                const count = this.state.generators[id];
                let multipliers = 0;
                if (count >= 10) multipliers++;
                if (count >= 25) multipliers++;
                if (count >= 50) multipliers++;
                if (count >= 100) multipliers++;
                if (count > 100) multipliers += Math.floor((count - 100) / 50);
                return Math.pow(2, multipliers);
            }

            getManagerMultiplier(industryId) {
                const activeId = this.state.activeManagers[industryId];
                if (!activeId) return 1;
                const options = MANAGER_OPTIONS[industryId];
                const mgr = options.find(m => m.id === activeId);
                if (!mgr) return 1;
                const lvl = this.state.managerLevels[activeId] || 1;
                return mgr.mult * Math.pow(2, lvl - 1);
            }
            
            getManagerUpgradeCost(mgr, currentLvl) {
                // Base costs per rarity
                const baseCosts = {
                    'common': 5,    // Green
                    'rare': 10,     // Blue
                    'legendary': 20 // Orange
                };
                const base = baseCosts[mgr.rarity] || 5;
                return base * currentLvl;
            }

            getGenRevenue(id) {
                const g = GENERATORS_DATA.find(x => x.id === id);
                let count = this.state.generators[id];
                let rev = g.baseRevenue * count;
                rev *= this.getManagerMultiplier(id);
                rev *= this.getGenMultiplier(id);
                rev *= this.state.prestigeMultiplier;
                rev *= this.getAdBoostMultiplier(); 
                return rev;
            }

            getGenUnhappiness(id) {
                const g = GENERATORS_DATA.find(x => x.id === id);
                return g.baseUnhappiness * this.state.generators[id];
            }

            getNextMilestone(id) {
                const count = this.state.generators[id];
                if (count < 10) return 10;
                if (count < 25) return 25;
                if (count < 50) return 50;
                if (count < 100) return 100;
                return Math.ceil((Math.max(count, 100) + 1) / 50) * 50;
            }

            getPrevMilestone(id) {
                const count = this.state.generators[id];
                if (count < 10) return 0;
                if (count < 25) return 10;
                if (count < 50) return 25;
                if (count < 100) return 50;
                return Math.floor((count - 1) / 50) * 50;
            }

            getUnhappinessThreshold() { return 25000 * Math.pow(10, this.state.level - 1); }
            getNextLevelMultiplier() { return Math.pow(2, this.state.level); }
            getAdBoostMultiplier() { return (Date.now() < this.state.adBoostExpiry) ? 2 : 1; }

            // --- INITIALIZATION ---
            init() {
                this.loadGame();
                if (!this.state.activeMissions[0]) this.generateMission(0);
                this.renderGenerators();
                this.renderMissions();
                this.startGameLoop();
                this.updateUI();
                this.updateLevelBadge();
                // Set Avatar
                if (this.state.customAvatar) {
                    document.getElementById('avatar-img').src = this.state.customAvatar;
                } else {
                    // Default avatar
                    document.getElementById('avatar-img').src = AVATAR_PRESETS[0];
                }
                
                // Setup Theory Point Tooltip
                const theoryTarget = document.getElementById('theory-counter-target');
                if(theoryTarget) {
                    theoryTarget.onclick = (e) => {
                        e.stopPropagation();
                        this.showContextToast(theoryTarget, "Use Theory Points to Upgrade Reps!", "info", 2500);
                    };
                }
            }
            
            watchAd(type) {
                const modal = document.getElementById('ad-modal');
                modal.classList.remove('hidden');
                
                // Reset Ad UI
                const bar = document.getElementById('ad-progress-bar');
                const text = document.getElementById('ad-timer-text');
                bar.style.width = '0%';
                text.innerText = "Please wait 3s...";
                
                // Animate Ad
                setTimeout(() => bar.style.width = '100%', 100);
                
                let timeLeft = 3;
                const timer = setInterval(() => {
                    timeLeft--;
                    if(timeLeft > 0) text.innerText = `Please wait ${timeLeft}s...`;
                    else {
                        text.innerText = "Done!";
                        clearInterval(timer);
                    }
                }, 1000);

                setTimeout(() => {
                    modal.classList.add('hidden');
                    if (type === 'boost') {
                        this.state.adBoostExpiry = Date.now() + 600000; 
                        this.showToast("x2 Boost Activated!");
                        this.animateGlobalPulse(); 
                    } else if (type === 'mission') {
                        this.state.adSlotUnlocked = true;
                        this.generateMission(2); 
                        this.showToast("Mission Slot Unlocked!");
                    }
                    this.updateUI();
                }, 3500);
            }
            
            animateGlobalPulse() {
                const allRevenueTexts = document.querySelectorAll('.revenue');
                allRevenueTexts.forEach(el => {
                    el.classList.add('animate-pulse-big');
                    setTimeout(() => el.classList.remove('animate-pulse-big'), 500);
                });
            }

            // ... (Other UI methods like properties) ...
            openPropertiesModal() {
                const modal = document.getElementById('properties-modal');
                const list = document.getElementById('properties-list');
                list.innerHTML = '';

                PROPERTIES_DATA.forEach(prop => {
                    const isOwned = this.state.ownedProperties.includes(prop.id);
                    const canAfford = this.state.influence >= prop.cost;
                    
                    const div = document.createElement('div');
                    div.className = `bg-white rounded-lg shadow-sm mb-3 border-2 relative overflow-hidden ${isOwned ? 'border-green-500 bg-green-50' : 'border-gray-200'}`;
                    
                    let actionBtn = '';
                    if (isOwned) {
                        actionBtn = `<button class="bg-green-600 text-white font-bold text-xs px-3 py-1.5 rounded cursor-default shadow-inner">OWNED</button>`;
                    } else {
                        actionBtn = `<button class="px-3 py-1.5 rounded text-xs font-bold shadow-sm transition ${canAfford ? 'bg-teal-600 text-white hover:bg-teal-500 btn-3d' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}" 
                                    ${!canAfford ? 'disabled' : ''}
                                    onclick="game.buyProperty('${prop.id}')">
                                Buy ${formatNumber(prop.cost)}
                            </button>`;
                    }

                    div.innerHTML = `
                        <div class="p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">${prop.icon}</div>
                                <div>
                                    <div class="font-bold text-gray-800 text-sm">${prop.name}</div>
                                    <div class="text-[10px] font-medium text-gray-500">${prop.desc}</div>
                                </div>
                            </div>
                            ${actionBtn}
                        </div>
                        ${isOwned ? '<div class="absolute top-0 right-0 bg-green-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl">ACQUIRED</div>' : ''}
                    `;
                    list.appendChild(div);
                });

                modal.classList.remove('hidden');
            }

            buyProperty(id) {
                const prop = PROPERTIES_DATA.find(p => p.id === id);
                if(!prop) return;
                
                if(this.state.ownedProperties.includes(id)) return;

                if(this.state.influence >= prop.cost) {
                    this.state.influence -= prop.cost;
                    this.updateMissionProgress('spend_cash', prop.cost);
                    this.updateMissionProgress('buy_property', 1, id);
                    this.state.ownedProperties.push(id);
                    this.updateHeader();
                    this.openPropertiesModal(); 
                    this.showToast(`Purchased ${prop.name}!`);
                } else {
                    this.showToast("Not enough funds!");
                }
            }

            // --- STIMULUS CHECK LOGIC ---
            checkStimulus() {
                if(this.state.stimulusActive) return;
                
                // Check if 120 seconds have passed since last stimulus
                if(Date.now() - this.state.lastStimulusTime > 120000) {
                    this.triggerStimulus();
                }
            }

            triggerStimulus() {
                this.state.stimulusActive = true;
                this.state.lastStimulusTime = Date.now();
                
                const overlay = document.getElementById('stimulus-overlay');
                const flyer = document.getElementById('stimulus-flyer');
                
                overlay.classList.remove('hidden');
                
                // Start Animation
                // Reset animation to ensure it plays
                flyer.style.animation = 'none';
                flyer.offsetHeight; /* trigger reflow */
                flyer.style.animation = 'bounceFly 0.8s infinite ease-in-out, flyAcross 8s linear forwards';
                
                // Auto-close if not clicked
                this.stimulusAnimationTimeout = setTimeout(() => {
                    this.endStimulus();
                }, 8000); // Match animation duration
            }

            endStimulus() {
                this.state.stimulusActive = false;
                const overlay = document.getElementById('stimulus-overlay');
                overlay.classList.add('hidden');
                
                const flyer = document.getElementById('stimulus-flyer');
                flyer.style.animation = 'none'; // Reset animation
                
                if(this.stimulusAnimationTimeout) clearTimeout(this.stimulusAnimationTimeout);
            }

            openStimulusModal(e) {
                e.stopPropagation();
                // Pause the auto-close timeout so user has time to decide
                if(this.stimulusAnimationTimeout) clearTimeout(this.stimulusAnimationTimeout);
                
                // Calculate potential reward
                let totalIPS = 0;
                GENERATORS_DATA.forEach(g => {
                    if(this.state.generators[g.id] > 0) {
                         totalIPS += this.getGenRevenue(g.id) / (g.cycleTime/1000);
                    }
                });
                // If IPS is 0, give a pity amount
                if(totalIPS === 0) totalIPS = 10;
                
                const reward = Math.floor(totalIPS * 60);
                
                document.getElementById('stimulus-amount-display').innerText = "$" + formatNumber(reward).replace("$","");
                document.getElementById('stimulus-modal').classList.remove('hidden');
            }

            closeStimulusModal() {
                document.getElementById('stimulus-modal').classList.add('hidden');
                this.endStimulus();
            }

            watchStimulusAd() {
                // Simulate Ad Watch
                document.getElementById('stimulus-modal').classList.add('hidden');
                const adModal = document.getElementById('ad-modal');
                adModal.classList.remove('hidden');
                
                // Reset Ad UI
                const bar = document.getElementById('ad-progress-bar');
                const text = document.getElementById('ad-timer-text');
                bar.style.width = '0%';
                text.innerText = "Please wait 3s...";
                
                // Animate Ad
                setTimeout(() => bar.style.width = '100%', 100);
                
                let timeLeft = 3;
                const timer = setInterval(() => {
                    timeLeft--;
                    if(timeLeft > 0) text.innerText = `Please wait ${timeLeft}s...`;
                    else {
                        text.innerText = "Done!";
                        clearInterval(timer);
                    }
                }, 1000);
                
                setTimeout(() => {
                    adModal.classList.add('hidden');
                    
                    // Calculate and Grant Reward
                    let totalIPS = 0;
                    GENERATORS_DATA.forEach(g => {
                        if(this.state.generators[g.id] > 0) {
                             totalIPS += this.getGenRevenue(g.id) / (g.cycleTime/1000);
                        }
                    });
                    if(totalIPS === 0) totalIPS = 10;
                    const reward = Math.floor(totalIPS * 60);
                    
                    this.addInfluence(reward);
                    this.showToast(`Received Stimulus: $${formatNumber(reward).replace("$","")}`);
                    this.animateGlobalPulse();
                    
                    this.endStimulus();
                }, 3500);
            }

            // ... (Profile methods) ...
            openProfileModal() {
                const modal = document.getElementById('profile-modal');
                const nameInput = document.getElementById('player-name-input');
                const avatarGrid = document.getElementById('avatar-grid');
                
                nameInput.value = this.state.playerName || "";

                document.getElementById('stat-taps').innerText = this.state.stats.taps.toLocaleString();
                document.getElementById('stat-upgrades').innerText = this.state.stats.upgrades.toLocaleString();
                document.getElementById('stat-managers').innerText = this.state.stats.managersHired.toLocaleString();
                document.getElementById('stat-mgr-upgrades').innerText = this.state.stats.managersUpgraded.toLocaleString();
                document.getElementById('stat-quests').innerText = this.state.stats.quests.toLocaleString();
                document.getElementById('stat-max-cash').innerText = "$" + formatNumber(this.state.stats.maxCash).replace("$", "");

                avatarGrid.innerHTML = "";
                AVATAR_PRESETS.forEach(url => {
                    const div = document.createElement('div');
                    const isActive = this.state.customAvatar === url || (!this.state.customAvatar && url === AVATAR_PRESETS[0]);
                    div.className = `aspect-square rounded-lg overflow-hidden border-4 cursor-pointer transition hover:scale-105 ${isActive ? 'border-green-500 ring-2 ring-green-300' : 'border-gray-300'}`;
                    div.onclick = () => this.setAvatar(url);
                    div.innerHTML = `<img src="${url}" class="w-full h-full object-cover bg-yellow-100">`;
                    avatarGrid.appendChild(div);
                });

                modal.classList.remove('hidden');
            }

            saveProfileName() {
                const nameInput = document.getElementById('player-name-input');
                const name = nameInput.value.trim();
                if(name) {
                    this.state.playerName = name;
                    this.showToast(`Welcome, ${name}!`);
                    this.saveGame();
                }
            }

            setAvatar(url) {
                this.state.customAvatar = url;
                document.getElementById('avatar-img').src = url;
                this.openProfileModal(); 
                this.saveGame();
            }
            
            // Calculate Income Per Second for Balancing
            calculateIPS() {
                let ips = 0;
                GENERATORS_DATA.forEach (g => {
                    if (this.state.generators[g.id] > 0) {
                        // Revenue per second = Revenue / (CycleTime in seconds)
                        let cycleS = g.cycleTime / 1000;
                        let rev = this.getGenRevenue(g.id);
                        ips += rev / cycleS;
                    }
                });
                // Return at least 1 to prevent division by zero errors in early game
                return ips > 0 ? ips : 1;
            }
            
            // Centralized progress updater for Action type quests
            updateMissionProgress(type, amount, targetId) {
                for (let i = 0; i < 3; i++) {
                    const m = this.state.activeMissions[i];
                    if (!m) continue;

                    // Check if mission type matches
                    if (m.type === type) {
                        // If mission has specific target (like taxes) check it matches
                        if (m.target && m.target !== targetId) continue;

                        //Increment progress
                        m.current = (m.current || 0) + amount;

                        // Trigger UI update
                        this.renderMissions();
                    }
                }
            }
            
            // --- MISSIONS ---
            generateMission(slot) {
                let mission = {};
                const ips = this.calculateIPS();

                // --- FIXED QUEST LINE (Slot 0 only) ---
                if (slot === 0) {
                    if (this.state.missionCount === 0) {
                        this.state.activeMissions[slot] = { type: 'buy_generator', target: 'taxes', count: 5, current: 0, reward: { type: 'money', val: ips * 100 }, text: "Buy 5 Tax Collection", icon: "üí∞" };
                        this.renderMissions(); return;
                    }
                    if (this.state.missionCount === 1) {
                        this.state.activeMissions [slot] = { type: 'buy_generator', target: 'taxes', count: 5, current: 0, reward: { type: 'money', val: ips * 20}, text: "Buy 5 Tax Collection", icon: "üí∞"};
                        this.renderMissions(); return;
                    }
                    if (this.state.missionCount === 2) {
                        this.state.activeMissions[slot] = { type: 'fundraise', count: 20, current: 0, reward: { type: 'money', val: 500 }, text: "Fundraise 20 Times", icon: "üì£" };
                        this.renderMissions(); return;
                    }
                    if (this.state.missionCount === 3) {
                        this.state.activeMissions[slot] = { type: 'hire_rep', target: 'taxes', reward: { type: 'money', val: ips * 20 }, text: "Hire Tax Rep", icon: "üëî" };
                        this.renderMissions(); return;
                    }
                }

                // --- PROCEDURAL QUEST GENERATION ---
                // Balancing: 45s of IPS (Standard) or 60s (Time Limited Slot 1)
                const duration = (slot === 1) ? 60 : 45; 
                const targetVal = ips * duration;

                // Filter available types based on game state
                const types = ['spend_cash', 'spend_theory', 'buy_generator', 'own_generators', 'reach_unhappiness', 'fundraise'];
                
                const unownedProps = PROPERTIES_DATA.filter(p => !this.state.ownedProperties.includes(p.id));
                if (unownedProps.length > 0) types.push('buy_property');
                
                const unhiredReps = Object.keys(MANAGER_OPTIONS).filter(k => !this.state.activeManagers[k]);
                if (unhiredReps.length > 0) types.push('hire_rep');

                const selectedType = types[Math.floor(Math.random() * types.length)];
                mission.type = selectedType;

                // --- TARGET CONFIGURATION ---
                if (selectedType === 'spend_cash') {
                    mission.count = Math.floor(targetVal);
                    mission.current = 0;
                    mission.text = `Spend $${formatNumber(mission.count)}`;
                    mission.icon = "üí∏";
                } 
                else if (selectedType === 'spend_theory') {
                    mission.count = Math.max(1, Math.floor(this.state.level)); 
                    mission.current = 0;
                    mission.text = `Spend ${mission.count} Theory`;
                    mission.icon = "üìò";
                } 
                else if (selectedType === 'buy_generator') {
                    // Pick random generator
                    const gen = GENERATORS_DATA[Math.floor(Math.random() * GENERATORS_DATA.length)];
                    const cost = this.getGenCost(gen.id);
                    // Calculate how many we can buy for targetVal (min 1)
                    let amount = Math.max(1, Math.floor(targetVal / Math.max(1, cost)));
                    mission.target = gen.id;
                    mission.count = amount;
                    mission.current = 0;
                    mission.text = `Buy ${amount} ${gen.name}`;
                    mission.icon = gen.icon;
                } 
                else if (selectedType === 'own_generators') {
                    const gen = GENERATORS_DATA[Math.floor(Math.random() * GENERATORS_DATA.length)];
                    const cost = this.getGenCost(gen.id);
                    let amount = Math.max(1, Math.floor(targetVal / Math.max(1, cost)));
                    mission.target = gen.id;
                    mission.count = this.state.generators[gen.id] + amount;
                    mission.text = `Own ${mission.count} ${gen.name}`;
                    mission.icon = gen.icon;
                } 
                else if (selectedType === 'reach_unhappiness') {
                    // Estimate unhappiness growth
                    let unhPerSec = 0;
                    GENERATORS_DATA.forEach(g => { 
                        if(this.state.generators[g.id]>0) unhPerSec += this.getGenUnhappiness(g.id) / (g.cycleTime/1000);
                    });
                    // Target is current + projected growth
                    const targetUnh = this.state.unhappiness + (unhPerSec * duration);
                    mission.count = Math.max(this.state.unhappiness + 100, Math.floor(targetUnh));
                    mission.text = `Reach ${formatUnhappiness(mission.count)} Anger`;
                    mission.icon = "üò°";
                } 
                else if (selectedType === 'buy_property') {
                    const prop = unownedProps[Math.floor(Math.random() * unownedProps.length)];
                    mission.target = prop.id;
                    mission.text = `Buy ${prop.name}`;
                    mission.icon = prop.icon;
                } 
                else if (selectedType === 'fundraise') {
                    mission.count = 60; // Fixed count for better UX
                    mission.current = 0;
                    mission.text = `Fundraise ${mission.count} Times`;
                    mission.icon = "üì£";
                } 
                else if (selectedType === 'hire_rep') {
                    const repId = unhiredReps[Math.floor(Math.random() * unhiredReps.length)];
                    const genName = GENERATORS_DATA.find(g => g.id === repId).name;
                    mission.target = repId;
                    mission.text = `Hire ${genName} Rep`;
                    mission.icon = "üëî";
                }

                // --- REWARD LOGIC ---
                // Slot 0: 50% Cash, 50% Theory
                // Slot 1/2: 40% Cash, 40% Theory, 20% Unhappiness
                let rnd = Math.random();
                let rewardType = 'money';
                
                if (slot === 0) {
                    if (rnd > 0.5) rewardType = 'theory';
                } else {
                    if (rnd < 0.4) rewardType = 'money';
                    else if (rnd < 0.8) rewardType = 'theory';
                    else rewardType = 'unhappiness';
                }

                if (rewardType === 'money') {
                    mission.reward = { type: 'money', val: ips * 20 };
                } else if (rewardType === 'theory') {
                    mission.reward = { type: 'theory', val: this.state.level };
                } else {
                    mission.reward = { type: 'unhappiness', val: 10 }; // 10%
                }

                this.state.activeMissions[slot] = mission;
                
                // Set timer for slot 1
                if (slot === 1) this.state.missionTimers[1] = Date.now() + this.missionConfig.midSlotDuration;
                
                this.renderMissions(); 
            }

            checkMissions() {
                // If Stimulus Overlay is active, pause time check
                if(this.state.stimulusActive) return;

                const now = Date.now();
                
                // Slot 0 (Standard)
                
                const timeSinceStart = now - this.levelStartTime;
                
                // Slot 1 (Timed)
                if (!this.state.activeMissions[1]) {
                    const cooldown = this.state.missionCooldowns[1];
                    
                    if (!cooldown) {
                        // Check if it's time to unlock AND we aren't already animating
                        if (timeSinceStart > this.missionConfig.midSlotUnlockTime) {
                            if (!this.midSlotUnlocking) {
                                this.triggerMidSlotUnlock(); // <--- CALL NEW ANIMATION FUNCTION
                            }
                        }
                    } else if (now > cooldown) {
                        this.generateMission(1);
                        this.state.missionCooldowns[1] = null;
                    }
                } else {
                    // ... existing expiry logic ...
                    if (now > this.state.missionTimers[1] && !this.isMissionComplete(this.state.activeMissions[1])) {
                         this.state.activeMissions[1] = null;
                         this.state.missionCooldowns[1] = now + this.missionConfig.midSlotCooldown;
                         this.renderMissions();
                    }
                }

                // Slot 2 (Ad)
                if (this.state.adSlotUnlocked) {
                    if (!this.state.activeMissions[2]) this.generateMission(2);
                }
            }
            triggerMidSlotUnlock() {
                this.midSlotUnlocking = true;
                
                // 1. Find the lock icon in the DOM
                const lockIcon = document.getElementById('mission-lock-icon');
                
                if (lockIcon) {
                    // 2. Play Shake Animation
                    lockIcon.classList.add('animate-lock-shake');
                    
                    // 3. After 1.5 seconds, explode/open
                    setTimeout(() => {
                        lockIcon.classList.remove('animate-lock-shake');
                        lockIcon.classList.remove('fa-lock');
                        lockIcon.classList.add('fa-unlock', 'animate-lock-open');
                        
                        // 4. After explosion finishes, generate mission
                        setTimeout(() => {
                            this.generateMission(1);
                            this.midSlotUnlocking = false;
                            this.showToast("New Mission Unlocked!");
                        }, 400); // Wait for open animation
                        
                    }, 1500); // Duration of shake
                } else {
                    // Fallback if UI isn't rendered for some reason
                    this.generateMission(1);
                    this.midSlotUnlocking = false;
                }
            }
            isMissionComplete(m) {
                if (!m) return false;
                // Incremental Action Quests
                if (m.type === 'buy_generator' || m.type === 'spend_cash' || 
                    m.type === 'spend_theory' || m.type === 'fundraise') {
                    return (m.current || 0) >= m.count;
                }
                // State Check Quests
                if (m.type === 'own_generators') return this.state.generators[m.target] >= m.count;
                if (m.type === 'reach_unhappiness') return this.state.unhappiness >= m.count;
                if (m.type === 'buy_property') return this.state.ownedProperties.includes(m.target);
                if (m.type === 'hire_rep') return !!this.state.activeManagers[m.target]; // Checks state directly
                
                return false;
            }
            claimMission(slot) {
                const m = this.state.activeMissions[slot];
                // Handle Rewards
                if (m.reward.type === 'money') this.addInfluence(m.reward.val);
                if (m.reward.type === 'theory') this.addTheoryPoint(m.reward.val);
                if (m.reward.type === 'unhappiness') {
                    // Reduce unhappiness by 10%
                    const reduction = Math.floor(this.state.unhappiness * 0.1);
                    this.state.unhappiness = Math.max(0, this.state.unhappiness - reduction);
                    this.showToast(`Unhappiness Reduced by ${formatUnhappiness(reduction)}!`);
                    this.updateHeader();
                } else {
                    this.showToast("Mission Completed!");
                }
                
                this.state.stats.quests++;

                this.state.activeMissions[slot] = null;
                if (slot === 0) this.state.missionCount++; 
                if (slot === 1) this.state.missionCooldowns[1] = Date.now() + this.missionConfig.midSlotCooldown;
                else this.generateMission(slot);
                this.renderMissions();
            }
            renderMissions() {
                const container = document.getElementById('mission-container');
                container.innerHTML = '';
                this.createMissionCard(container, 0);
                this.createMissionCard(container, 1);
                if (this.state.adSlotUnlocked) {
                    this.createMissionCard(container, 2);
                } else {
                    const adCard = document.createElement('div');
                    adCard.className = 'mission-card mission-card-locked-ad flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 transition shadow-sm';
                    adCard.onclick = () => this.watchAd('mission');
                    adCard.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center mb-1 shadow-sm">
                            <i class="fas fa-play text-white text-xs ml-0.5"></i>
                        </div>
                        <div class="text-[10px] font-black text-gray-800 leading-tight">Unlock Slot</div>
                        <div class="text-[9px] text-teal-700 font-bold">For this Level</div>
                    `;
                    container.appendChild(adCard);
                }
            }
            createMissionCard(container, slot) {
                const m = this.state.activeMissions[slot];
                const div = document.createElement('div');
                div.className = 'mission-card relative overflow-hidden cursor-pointer';

                if (!m) {
                    if (slot === 1) {
                        const cooldown = this.state.missionCooldowns[1];
                        if (cooldown) {
                             const wait = Math.max(0, Math.ceil((cooldown - Date.now()) / 1000));
                             div.innerHTML = `<div class="text-xs text-teal-800 font-bold text-center">New Orders<br>in ${wait}s</div>`;
                        } else if (Date.now() - this.levelStartTime < this.missionConfig.midSlotUnlockTime) {
                            // UPDATED: Added ID 'mission-lock-icon' and changed icon to fa-lock
                            div.innerHTML = `
                                <div class="flex flex-col items-center justify-center text-gray-500">
                                    <i id="mission-lock-icon" class="fas fa-lock text-xl mb-1"></i> 
                                    <div class="text-[10px] font-bold uppercase tracking-wider">Locked</div>
                                </div>`;
                        }
                    } else div.innerHTML = `...`;
                } else {
                    if (this.isMissionComplete(m)) {
                        div.className = 'mission-card bg-green-500 border-green-700 shadow-lg animate-pulse cursor-pointer flex flex-col items-center justify-center claim-mode';
                        div.onclick = (e) => { 
                            e.stopPropagation();
                            div.style.transform = "scale(0.95)";
                            setTimeout(() => this.claimMission(slot), 100);
                        };
                        
                        // Render Reward Icon
                        let rewardIcon = 'üí∞';
                        let rewardText = '';
                        if (m.reward.type === 'money') {
                            rewardIcon = 'üí∞';
                            rewardText = formatNumber(m.reward.val).replace('$','');
                        } else if (m.reward.type === 'theory') {
                            rewardIcon = 'üìò';
                            rewardText = m.reward.val;
                        } else if (m.reward.type === 'unhappiness') {
                            rewardIcon = 'üïäÔ∏è';
                            rewardText = "-10% üò°";
                        }

                        div.innerHTML = `
                            <div class="text-white font-black text-lg drop-shadow-md mb-1">CLAIM!</div>
                            <div class="flex items-center justify-center bg-white bg-opacity-20 rounded-full px-3 py-1">
                                <span class="text-xl mr-1">${rewardIcon}</span>
                                <span class="text-white font-bold text-sm">${rewardText}</span>
                            </div>
                        `;
                    } else {
                        let progress = 0;
                        
                        // --- PROGRESS BAR CALCULATION FIX ---
                        if (m.type === 'buy_generator' || m.type === 'spend_cash' || 
                            m.type === 'spend_theory' || m.type === 'fundraise') {
                            progress = Math.min(100, ((m.current || 0) / m.count) * 100);
                        } 
                        else if (m.type === 'own_generators') {
                            // Look at actual Owned Count, not mission current
                            progress = Math.min(100, (this.state.generators[m.target] / m.count) * 100);
                        }
                        else if (m.type === 'reach_unhappiness') {
                            // Look at actual Unhappiness
                            progress = Math.min(100, (this.state.unhappiness / m.count) * 100);
                        }
                        else if (m.type === 'hire_rep' || m.type === 'buy_property') {
                            // Binary progress
                            progress = 0; 
                        }
                        
                        let timerHtml = '';
                        if (slot === 1) {
                            const timeLeft = Math.max(0, (this.state.missionTimers[1] - Date.now()));
                            let timerClass = "mission-timer";
                            if (timeLeft < 10000) timerClass += " bg-red-600 animate-pulse"; 
                            timerHtml = `<div class="${timerClass}">${formatTime(timeLeft)}</div>`;
                        }
                        
                        // Render Reward Preview
                        let rewardDisplay = '';
                        if (m.reward.type === 'money') rewardDisplay = '$' + formatNumber(m.reward.val).replace('$','');
                        else if (m.reward.type === 'theory') rewardDisplay = 'üìò' + m.reward.val;
                        else rewardDisplay = '-10% üò°';

                        div.innerHTML = `${timerHtml}
                            <div class="mission-icon">${m.icon || '‚≠ê'}</div>
                            <div class="text-[9px] font-bold text-center leading-tight z-10 relative">${m.text}</div>
                            <div class="w-full bg-gray-300 h-1.5 mt-1 rounded-full overflow-hidden z-10 relative">
                                <div class="bg-green-500 h-full" style="width: ${progress}%"></div>
                            </div>
                            <div class="text-[9px] text-teal-900 font-bold mt-0.5 z-10 relative">Reward: ${rewardDisplay}</div>`;
                    }
                }
                container.appendChild(div);
            }

            // ... (Existing notification and modal methods) ...
            checkRepNotification() {
                const notification = document.getElementById('rep-notification');
                if (!notification) return;
                if (this.state.theoryPoints >= 5) {
                    notification.classList.remove('hidden');
                } else {
                    notification.classList.add('hidden');
                }
            }

            openAllRepsModal() {
                const notification = document.getElementById('rep-notification');
                if (notification) notification.classList.add('hidden');
                const modal = document.getElementById('all-reps-modal');
                const list = document.getElementById('all-reps-list');
                list.innerHTML = '';
                const mt = document.getElementById('modal-theory-display');
                if(mt) mt.innerText = this.state.theoryPoints;
                GENERATORS_DATA.forEach(gen => {
                    const header = document.createElement('div');
                    header.className = "flex items-center gap-2 mb-2 mt-4 pb-1 border-b border-teal-200 first:mt-0";
                    header.innerHTML = `<span class="text-xl">${gen.icon}</span> <h3 class="font-bold text-teal-800">${gen.name}</h3>`;
                    list.appendChild(header);
                    const options = MANAGER_OPTIONS[gen.id];
                    options.forEach(mgr => {
                        const activeId = this.state.activeManagers[gen.id];
                        const isHired = activeId === mgr.id;
                        const lvl = this.state.managerLevels[mgr.id] || 1;
                        const maxLvl = 10;
                        
                        let rarityClass = "border-gray-200 bg-white";
                        let rarityBadge = "";
                        if (mgr.rarity === 'common') {
                            rarityClass = "border-green-400 bg-green-50";
                            rarityBadge = `<span class="text-[8px] uppercase bg-green-200 text-green-800 px-1 rounded border border-green-300 ml-2">Common</span>`;
                        } else if (mgr.rarity === 'rare') {
                            rarityClass = "border-blue-400 bg-blue-50";
                            rarityBadge = `<span class="text-[8px] uppercase bg-blue-200 text-blue-800 px-1 rounded border border-blue-300 ml-2">Rare</span>`;
                        } else if (mgr.rarity === 'legendary') {
                            rarityClass = "border-orange-400 bg-orange-50";
                            rarityBadge = `<span class="text-[8px] uppercase bg-orange-200 text-orange-800 px-1 rounded border border-orange-300 ml-2">Legendary</span>`;
                        }

                        const div = document.createElement('div');
                        div.className = `${rarityClass} p-3 rounded-lg shadow-sm mb-2 border flex flex-col gap-2`;
                        let actionBtn = `<button class="btn-hire px-3 py-1.5 rounded text-xs font-bold uppercase shadow-sm transition ${isHired ? 'bg-green-100 text-green-700 cursor-default' : 'bg-teal-600 text-white hover:bg-teal-500 btn-3d'}" 
                                    ${isHired ? 'disabled' : ''}
                                    onclick="game.hireManager('${gen.id}', '${mgr.id}', ${mgr.cost}, event)">
                                ${isHired ? 'Active' : `${formatNumber(mgr.cost)}`}
                            </button>`;
                        
                        let upgradeRow = "";
                        if (isHired) {
                             const upgCost = this.getManagerUpgradeCost(mgr, lvl);
                             const canAfford = this.state.theoryPoints >= upgCost;
                             
                             upgradeRow = `
                                <div class="flex items-center justify-between bg-white bg-opacity-50 p-2 rounded border border-black border-opacity-5 mt-1">
                                    <div class="text-xs text-gray-800 font-bold">Level ${lvl}/${maxLvl}</div>
                                    <button class="text-[10px] font-bold px-2 py-1 rounded shadow disabled:opacity-50 transition ${canAfford ? 'bg-blue-500 hover:bg-blue-400 text-white' : 'bg-gray-400 text-gray-200'}" 
                                            ${(!canAfford || lvl >= maxLvl) ? 'disabled' : ''}
                                            onclick="game.upgradeManager('${mgr.id}', '${gen.id}', event)">
                                        ${lvl >= maxLvl ? 'MAX' : `Upgrade (${upgCost} üìò)`}
                                    </button>
                                </div>
                             `;
                        }
                        div.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <img id="mgr-img-${mgr.id}" src="${mgr.img}" class="w-10 h-10 rounded-full border-2 border-teal-500 bg-white transition-opacity duration-300">
                                    <div>
                                        <div class="font-bold text-gray-800 text-sm flex items-center">${mgr.name} ${rarityBadge}</div>
                                        <div class="text-xs font-bold text-orange-600">Current: x${mgr.mult * Math.pow(2, lvl-1)}</div>
                                    </div>
                                </div>
                                ${actionBtn}
                            </div>
                            ${upgradeRow}
                        `;
                        list.appendChild(div);
                    });
                });
                modal.classList.remove('hidden');
            }

            updateUI() {
                this.updateHeader();
                Object.keys(this.state.generators).forEach(id => {
                    this.updateCardUI(id);
                });
                this.updateMissionVisuals();
                this.checkRepNotification(); 
            }

            updateHeader() {
                const el = document.getElementById('influence-display');
                if(el) el.innerText = formatNumber(this.state.influence).replace("$", "");
                const theoryEl = document.getElementById('theory-display');
                if(theoryEl) theoryEl.innerText = this.state.theoryPoints; 
                const unh = this.state.unhappiness;
                const limit = this.getUnhappinessThreshold();
                const pct = Math.min(100, (unh / limit) * 100);
                const unhDisplay = document.getElementById('unhappiness-display');
                if(unhDisplay) unhDisplay.innerText = formatUnhappiness(unh);
                const unhLimit = document.getElementById('unhappiness-limit');
                if(unhLimit) unhLimit.innerText = formatUnhappiness(limit);
                const unhBar = document.getElementById('unhappiness-bar');
                if(unhBar) unhBar.style.width = `${pct}%`;
                
                const boostBadge = document.getElementById('boost-badge');
                if (boostBadge) {
                    if (this.getAdBoostMultiplier() > 1) boostBadge.classList.remove('hidden');
                    else boostBadge.classList.add('hidden');
                }
                const adText = document.getElementById('ad-boost-text');
                const adBtn = document.getElementById('ad-boost-btn');
                if (adText && adBtn) {
                    if (this.getAdBoostMultiplier() > 1) {
                        const remaining = Math.max(0, this.state.adBoostExpiry - Date.now());
                        adText.innerText = formatTime(remaining);
                        adBtn.classList.add('boost-active');
                    } else {
                        adText.innerText = "Boost";
                        adBtn.classList.remove('boost-active');
                    }
                }
            }

            // ... (Prestige and Ladder logic) ...
            checkPrestigeCondition() {
                if (this.prestigePending) return;
                if (this.state.unhappiness >= this.getUnhappinessThreshold()) {
                    this.showPrestigeModal();
                }
            }
            showPrestigeModal() {
                this.prestigePending = true; 
                const modal = document.getElementById('prestige-modal');
                document.getElementById('prestige-bonus-display').innerText = `Production x${this.getNextLevelMultiplier()}`;
                document.getElementById('next-level-display').innerText = this.state.level + 1;
                modal.classList.remove('hidden');
            }
            closePrestigeModal() {
                if (this.state.unhappiness >= this.getUnhappinessThreshold()) {
                    this.showToast("Cannot ignore the people's anger!");
                    return;
                }
                this.prestigePending = false;
                document.getElementById('prestige-modal').classList.add('hidden');
            }
            startPrestigeSequence() {
                document.getElementById('prestige-modal').classList.add('hidden');
                const overlay = document.getElementById('revolution-overlay');
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    // Show Ladder
                    overlay.classList.add('hidden');
                    this.showLevelLadder();
                }, 3500);
            }
            showLevelLadder() {
                const overlay = document.getElementById('level-ladder-overlay');
                const stepsContainer = document.getElementById('ladder-steps');
                stepsContainer.innerHTML = '';
                const currentLvl = this.state.level;
                const levelsToShow = 5; 
                const stepElements = [];

                for (let i = 0; i < levelsToShow; i++) {
                    const l = currentLvl + i;
                    const step = document.createElement('div');
                    step.className = 'ladder-step';
                    step.innerText = l;
                    
                    if (i === 0) {
                        step.classList.add('active-step'); 
                        const avatar = document.createElement('div');
                        avatar.className = 'ladder-avatar';
                        const avatarSrc = document.getElementById('avatar-img').src;
                        avatar.innerHTML = `<img src="${avatarSrc}" class="w-full h-full object-cover">`;
                        avatar.id = 'climbing-avatar';
                        step.appendChild(avatar);
                    }
                    stepsContainer.appendChild(step);
                    stepElements.push(step);
                }
                overlay.classList.remove('hidden');
                
                setTimeout(() => {
                    const avatar = document.getElementById('climbing-avatar');
                    if (stepElements.length >= 2) {
                        const currentBox = stepElements[0].getBoundingClientRect(); 
                        const nextBox = stepElements[1].getBoundingClientRect();    
                        const distance = currentBox.bottom - nextBox.bottom;
                        avatar.style.bottom = (5 + distance) + 'px'; 
                    } else {
                        avatar.style.bottom = '125px';
                    }
                }, 500);
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    this.prestige();
                }, 4500); 
            }
            prestige() {
                this.state.level++;
                this.state.prestigeMultiplier = Math.pow(2, this.state.level - 1);
                this.state.influence = 0;
                this.state.unhappiness = 0;
                this.state.lifetime = 0;
                this.levelStartTime = Date.now();
                GENERATORS_DATA.forEach(g => {
                    this.state.generators[g.id] = 0;
                    this.state.progress[g.id] = 0;
                    this.state.activeManagers[g.id] = null;
                });
                this.state.activeMissions = {};
                this.state.missionCount = 0; 
                this.state.missionTimers = {};
                this.state.missionCooldowns = {};
                this.state.adSlotUnlocked = false; 
                this.saveGame();
                this.prestigePending = false;
                this.generateMission(0);
                this.renderGenerators(); 
                this.updateUI();
                this.updateLevelBadge();
                this.showToast(`Revolution Successful! Production x${this.state.prestigeMultiplier}`);
            }
            updateLevelBadge() {
                const el = document.getElementById('level-badge');
                el.innerText = `LVL ${this.state.level}`;
                if(this.state.level > 1) {
                    el.classList.add('bg-purple-600', 'border-purple-400');
                    el.classList.remove('bg-orange-500');
                }
            }
            manualClick(e) {
                if(this.prestigePending) return;
                let totalIPS = 0;
                GENERATORS_DATA.forEach(g => {
                    if(this.state.generators[g.id] > 0 && this.state.activeManagers[g.id]) {
                         totalIPS += this.getGenRevenue(g.id) / (g.cycleTime/1000);
                    }
                });
                const val = 1 + (totalIPS * 0.05);
                this.addInfluence(val);
                
                this.state.stats.taps++;
                this.updateMissionProgress('fundraise', 1);
                this.spawnFloatText(e.clientX, e.clientY, `+${formatNumber(val)}`);
                for (let i = 0; i < 3; i++) { 
                    if (this.state.activeMissions[i] && this.state.activeMissions[i].type === 'click') {
                        this.state.activeMissions[i].current++;
                    }
                }
                const img = document.getElementById('avatar-img');
                img.style.transform = "scale(0.9)";
                setTimeout(()=>img.style.transform = "scale(1)", 50);
            }
            addInfluence(amt) {
                this.state.influence += amt;
                this.state.lifetime += amt;
                
                if (this.state.influence > this.state.stats.maxCash) {
                    this.state.stats.maxCash = this.state.influence;
                }

                if (amt > 0) {
                    const txt = document.getElementById('money-text');
                    if (txt) {
                        txt.classList.remove('money-normal');
                        txt.classList.add('money-pulse');
                        if (this.moneyPulseTimeout) clearTimeout(this.moneyPulseTimeout);
                        this.moneyPulseTimeout = setTimeout(() => {
                            txt.classList.remove('money-pulse');
                            txt.classList.add('money-normal');
                        }, 100);
                    }
                }
                const el = document.getElementById('influence-display');
                if(el) el.innerText = formatNumber(this.state.influence).replace("$", "");
            }
            addUnhappiness(amt) {
                this.state.unhappiness += amt;
                this.updateHeader(); 
                this.checkPrestigeCondition();
                // Force mission check if we have an anger mission
                if (Object.values(this.state.activeMissions).some(m => m && m.type === 'reach_unhappiness')) {
                    this.renderMissions();
                }
            }
            addTheoryPoint(amt) {
                this.state.theoryPoints += amt;
                this.updateHeader();
                this.showToast("Gained " + amt + " Theory Point!");
            }
            activateGenerator(id) {
                if(this.prestigePending) return;
                if (this.state.generators[id] === 0) {
                     const card = document.getElementById(`card-${id}`);
                     const icon = card.querySelector('.ring-container');
                     this.showContextToast(icon, "Buy first!");
                     return;
                }
                if(this.state.generators[id] > 0 && !this.state.activeManagers[id]) {
                     if(this.state.progress[id] <= 0) { 
                         this.state.progress[id] = 1; 
                         const card = document.getElementById(`card-${id}`);
                         card.style.transform = "scale(0.98)";
                         setTimeout(() => card.style.transform = "scale(1)", 50);
                         this.manualUsageTrackers[id] = null; 
                     }
                }
            }
            startBuy(id) {
                if(this.prestigePending) return;
                if (this.isBuying) return; 
                this.isBuying = true;
                this.buyGenerator(id);
                this.buyInterval = setTimeout(() => {
                    if (!this.isBuying) return; 
                    this.buyInterval = setInterval(() => {
                        this.buyGenerator(id);
                    }, 100); 
                }, 500);
            }
            stopBuy() {
                this.isBuying = false;
                clearTimeout(this.buyInterval);
                clearInterval(this.buyInterval);
            }
            buyGenerator(id, e) {
                if(this.prestigePending) return;
                const cost = this.getGenCost(id);
                const prevRevenue = this.getGenRevenue(id);
                if(this.state.influence >= cost) {
                    const prevMult = this.getGenMultiplier(id);
                    this.state.influence -= cost;
                    this.state.generators[id]++;
                    
                    this.state.stats.upgrades++;

                    const newMult = this.getGenMultiplier(id);
                    if(this.state.generators[id] === 1) this.state.progress[id] = 0;
                    this.updateCardUI(id);
                    this.updateHeader();
                    if (newMult > prevMult) {
                        const newRevenue = this.getGenRevenue(id);
                        this.animateMultiplierFlight(id, newMult, prevRevenue, newRevenue);
                        this.addTheoryPoint(5); 
                        const card = document.getElementById(`card-${id}`);
                        const icon = card.querySelector('.emoji');
                        this.animateTheoryPointBurst(icon, 5);
                    }

                    // QUEST UPDATES
                    this.updateMissionProgress('spend_cash', cost);
                    this.updateMissionProgress('buy_generator', 1, id);
                    this.renderMissions(); // Force render for 'own_generators' quests

                } else {
                    if(e) { this.showContextToast(e.target, "Not enough funds!"); }
                }
            }
            animateMultiplierFlight(id, newMult, startVal, endVal) {
                const card = document.getElementById(`card-${id}`);
                if(!card) return;
                const badge = card.querySelector('.multiplier-badge');
                const revenueText = card.querySelector('.revenue');
                badge.innerText = 'x' + newMult;
                badge.classList.remove('badge-hidden');
                badge.classList.add('badge-visible');
                const startRect = badge.getBoundingClientRect();
                const endRect = revenueText.getBoundingClientRect();
                const flyer = badge.cloneNode(true);
                flyer.style.position = 'fixed';
                flyer.style.left = `${startRect.left}px`;
                flyer.style.top = `${startRect.top}px`;
                flyer.style.zIndex = 9999;
                flyer.style.margin = 0;
                document.body.appendChild(flyer);
                badge.classList.remove('badge-visible');
                badge.classList.add('badge-hidden');
                const animation = flyer.animate([
                    { transform: `translate(0, 0) scale(1)` },
                    { transform: `translate(${endRect.left - startRect.left + endRect.width/2}px, ${endRect.top - startRect.top}px) scale(0.5)`, opacity: 0 }
                ], { duration: 800, easing: 'ease-in-out' });
                animation.onfinish = () => {
                    flyer.remove();
                    this.animateCountUp(revenueText, startVal, endVal, 600);
                };
            }
            animateCountUp(element, start, end, duration) {
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    const current = Math.floor(progress * (end - start) + start);
                    element.innerText = "+" + formatNumber(current);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        element.innerText = "+" + formatNumber(end);
                    }
                };
                window.requestAnimationFrame(step);
            }
            startGameLoop() {
                const loop = () => {
                    const now = Date.now();
                    const dt = now - this.lastTick;
                    this.lastTick = now;
                    if (!this.prestigePending && dt > 0) {
                        this.processProduction(dt);
                        this.updateProgressBars();
                        this.checkMissions(); 
                        // NEW: Check stimulus
                        this.checkStimulus();
                        
                        this.updateMissionVisuals();
                        this.updateHeader(); 
                    }
                    requestAnimationFrame(loop);
                };
                requestAnimationFrame(loop);
                setInterval(() => this.checkAffordability(), 200);
                setInterval(() => this.saveGame(), 30000);
            }

            updateMissionVisuals() {
                const container = document.getElementById('mission-container');
                if (!container) return;
                for(let i=0; i<3; i++) {
                    const m = this.state.activeMissions[i];
                    const card = container.children[i];
                    if(!card) continue;

                    if(m) {
                        let progress = 0;
                        
                        // --- PROGRESS BAR CALCULATION FIX ---
                        if (m.type === 'buy_generator' || m.type === 'spend_cash' || 
                            m.type === 'spend_theory' || m.type === 'fundraise') {
                            progress = Math.min(100, ((m.current || 0) / m.count) * 100);
                        } 
                        else if (m.type === 'own_generators') {
                            // Look at actual Owned Count, not mission current
                            progress = Math.min(100, (this.state.generators[m.target] / m.count) * 100);
                        }
                        else if (m.type === 'reach_unhappiness') {
                            // Look at actual Unhappiness
                            progress = Math.min(100, (this.state.unhappiness / m.count) * 100);
                        }
                        else if (m.type === 'hire_rep' || m.type === 'buy_property') {
                            // Binary progress
                            progress = 0; 
                        }
                        
                        const bar = card.querySelector('.bg-green-500');
                        if(bar) bar.style.width = `${progress}%`;
                        
                        if(progress >= 100) {
                            if(!card.classList.contains('claim-mode')) {
                                this.renderMissions();
                                return; 
                            }
                        }

                        if(i === 1 && !card.classList.contains('claim-mode')) {
                            const timerEl = card.querySelector('.mission-timer');
                            if(timerEl) {
                                // If stimulus active, display "PAUSED" or just current time without counting down
                                if(this.state.stimulusActive) {
                                    timerEl.innerText = "PAUSED";
                                    timerEl.classList.add('bg-gray-500');
                                } else {
                                    const timeLeft = Math.max(0, (this.state.missionTimers[1] - Date.now()));
                                    timerEl.innerText = formatTime(timeLeft);
                                    timerEl.classList.remove('bg-gray-500');
                                    if(timeLeft < 10000) timerEl.classList.add('bg-red-600', 'animate-pulse');
                                }
                            }
                        }
                    } else if(i === 1) {
                         const cooldown = this.state.missionCooldowns[1];
                         if (cooldown) {
                             const wait = Math.max(0, Math.ceil((cooldown - Date.now()) / 1000));
                             const txt = card.querySelector('div.text-center'); 
                             if(txt && txt.innerHTML.includes('New Orders')) {
                                 txt.innerHTML = `New Orders<br>in ${wait}s`;
                             }
                         }
                    }
                }
            }

            processProduction(dt) {
                GENERATORS_DATA.forEach(g => {
                    const count = this.state.generators[g.id];
                    const hasManager = this.state.activeManagers[g.id];
                    if(count > 0) {
                        if(hasManager || this.state.progress[g.id] > 0) {
                             this.state.progress[g.id] += dt;
                             if(this.state.progress[g.id] >= g.cycleTime) {
                                const revenue = this.getGenRevenue(g.id);
                                const unhappiness = this.getGenUnhappiness(g.id);
                                const cycles = Math.floor(this.state.progress[g.id] / g.cycleTime);
                                this.addInfluence(revenue * cycles);
                                this.addUnhappiness(unhappiness * cycles);
                                if (!hasManager) this.animateCashBill(g.id);
                                if(hasManager) this.state.progress[g.id] %= g.cycleTime;
                                else this.state.progress[g.id] = 0; 
                             }
                        }
                    }
                });
            }
            animateCashBill(genId) {
                const card = document.getElementById(`card-${genId}`);
                if (!card) return;
                const progressBar = card.querySelector('.progress-fill');
                const startRect = progressBar.getBoundingClientRect();
                const target = document.getElementById('influence-display');
                const targetRect = target.getBoundingClientRect();
                const targetCenterX = targetRect.left + targetRect.width / 2;
                const targetCenterY = targetRect.top + targetRect.height / 2;
                const bill = document.createElement('div');
                bill.className = 'flying-bill';
                bill.innerText = '$'; 
                bill.style.left = `${startRect.right - 10}px`;
                bill.style.top = `${startRect.top}px`;
                document.body.appendChild(bill);
                const animation = bill.animate([
                    { transform: `translate(0, 0) scale(1)`, opacity: 1 },
                    { transform: `translate(${targetCenterX - startRect.right}px, ${targetCenterY - startRect.top}px) scale(0.5)`, opacity: 0 }
                ], { duration: 800, easing: 'ease-in' });
                animation.onfinish = () => bill.remove();
            }
            updateProgressBars() {
                GENERATORS_DATA.forEach(g => {
                    const card = document.getElementById(`card-${g.id}`);
                    if(!card) return;
                    const count = this.state.generators[g.id];
                    const bar = card.querySelector('.progress-fill');
                    const txt = card.querySelector('.timer-text');
                    const hasManager = this.state.activeManagers[g.id];
                    const isRunning = this.state.progress[g.id] > 0;
                    if(count > 0) {
                        if(!hasManager && !isRunning) {
                            txt.innerText = "TAP!";
                            bar.style.width = '0%';
                        } else {
                            const pct = Math.min(100, (this.state.progress[g.id] / g.cycleTime) * 100);
                            bar.style.width = `${pct}%`;
                            if(g.cycleTime < 300) txt.innerText = "FLOWING";
                            else txt.innerText = formatTime(g.cycleTime - this.state.progress[g.id]);
                        }
                    } else {
                        bar.style.width = '0%';
                        txt.innerText = formatTime(g.cycleTime);
                    }
                });
            }
            openManagerModal(industryId) {
                const modal = document.getElementById('manager-modal');
                const list = document.getElementById('modal-list');
                const options = MANAGER_OPTIONS[industryId];
                list.innerHTML = '';
                options.forEach(mgr => {
                    const activeId = this.state.activeManagers[industryId];
                    const isHired = activeId === mgr.id;
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded-lg shadow-sm mb-2 border border-gray-200 flex items-center justify-between";
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${mgr.img}" class="w-12 h-12 rounded-full border-2 border-teal-500">
                            <div>
                                <div class="font-bold text-gray-800">${mgr.name}</div>
                                <div class="text-xs font-bold text-orange-600">x${mgr.mult} Production</div>
                            </div>
                        </div>
                        <button class="btn-hire px-3 py-1.5 rounded text-xs font-bold uppercase shadow-sm transition ${isHired ? 'bg-green-100 text-green-700 cursor-default' : 'bg-teal-600 text-white hover:bg-teal-500 btn-3d'}" 
                                ${isHired ? 'disabled' : ''}
                                onclick="game.hireManager('${industryId}', '${mgr.id}', ${mgr.cost}, event)">
                            ${isHired ? 'Active' : `${formatNumber(mgr.cost)}`}
                        </button>
                    `;
                    list.appendChild(div);
                });
                modal.classList.remove('hidden');
            }
            upgradeManager(mgrId, genId, event) {
                // Find Manager details to get cost
                const industry = MANAGER_OPTIONS[genId];
                const mgr = industry.find(m => m.id === mgrId);
                const currentLvl = this.state.managerLevels[mgrId] || 1;
                const cost = this.getManagerUpgradeCost(mgr, currentLvl);

                if (this.state.theoryPoints >= cost) {
                    // 1. Deduct Cost & Upgrade Logic
                    this.state.theoryPoints -= cost;
                    this.updateMissionProgress('spend_theory', cost);
                    if (!this.state.managerLevels[mgrId]) this.state.managerLevels[mgrId] = 1;
                    this.state.managerLevels[mgrId]++;
                    
                    // 2. Calculate values for animation
                    const oldMult = mgr.mult * Math.pow(2, currentLvl - 1);
                    const newMult = mgr.mult * Math.pow(2, currentLvl);

                    // 3. Update Stats & UI Header
                    this.state.stats.managersUpgraded++;
                    this.updateHeader();

                    // 4. Trigger the Animation
                    this.animateManagerUpgradeEffect(mgrId, mgr.img, oldMult, newMult, () => {
                        // Callback: Runs AFTER animation finishes
                        this.updateCardUI(genId);
                        this.openAllRepsModal(); 
                        this.showToast("Upgrade Complete!");
                    }); // <--- This ); was missing/misplaced in your code
                } else {
                    if(event && event.target) this.showContextToast(event.target, "Need more Theory!", "info");
                }
            }
            closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
            hireManager(industryId, mgrId, cost, e) {
                if (this.state.influence >= cost) {
                    this.state.influence -= cost;
                    
                    // QUEST UPDATE
                    this.updateMissionProgress('spend_cash', cost);
                    this.updateMissionProgress('hire_rep', 1, industryId);
                    
                    this.state.activeManagers[industryId] = mgrId;
                    
                    // Track Stat
                    this.state.stats.managersHired++;

                    this.updateHeader();
                    this.updateCardUI(industryId);
                    if(!document.getElementById('manager-modal').classList.contains('hidden')) this.openManagerModal(industryId);
                    if(!document.getElementById('all-reps-modal').classList.contains('hidden')) this.openAllRepsModal();
                    if(e && e.target) this.showContextToast(e.target, "Manager Hired!", "success");
                    else this.showToast("Manager Hired!");
                    const card = document.getElementById(`card-${industryId}`);
                    if(card) {
                        const icon = card.querySelector('.ring-container');
                        icon.classList.remove('animate-wiggle');
                    }
                } else {
                    if(e && e.target) { this.showContextToast(e.target, "Not enough funds!"); } 
                    else { this.showToast("Not enough funds!"); }
                }
            }
            // Modified to accept duration
            showContextToast(targetEl, text, type, duration = 1000) {
                const rect = targetEl.getBoundingClientRect();
                const toast = document.createElement('div');
                toast.className = 'context-toast';
                if(type === 'success') toast.classList.add('success');
                if(type === 'info') toast.classList.add('info');
                
                toast.innerText = text;
                toast.style.left = `${rect.left}px`;
                toast.style.top = `${rect.top - 30}px`;
                
                // Adjust animation duration based on timeout
                if(duration > 1500) {
                    toast.style.animation = `fadeUpLong ${duration/1000}s forwards`;
                } else {
                    toast.style.animation = `fadeUp ${duration/1000}s forwards`;
                }

                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), duration);
            }
            animateTheoryPointBurst(startEl, count) {
                if(!startEl) return;
                const rect = startEl.getBoundingClientRect();
                const target = document.getElementById('theory-counter-target');
                const targetRect = target ? target.getBoundingClientRect() : { left: window.innerWidth/2, top: 0 };
                for(let i=0; i<count; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'flying-particle';
                        particle.innerText = 'üìò';
                        const randX = (Math.random() - 0.5) * 50;
                        const randY = (Math.random() - 0.5) * 50;
                        particle.style.left = `${rect.left + randX}px`;
                        particle.style.top = `${rect.top + randY}px`;
                        document.body.appendChild(particle);
                        const duration = 1200 + Math.random() * 600;
                        const animation = particle.animate([
                            { transform: `translate(0, 0) scale(1)` },
                            { transform: `translate(${targetRect.left - rect.left - randX}px, ${targetRect.top - rect.top - randY}px) scale(0.5)` }
                        ], { duration: duration, easing: 'cubic-bezier(0.19, 1, 0.22, 1)' });
                        animation.onfinish = () => {
                            particle.remove();
                            if(i === count-1) { 
                                target.classList.add('animate-wiggle');
                                setTimeout(()=>target.classList.remove('animate-wiggle'), 200);
                            }
                        };
                    }, i * 150); 
                }
            }
            checkAffordability() {
                if(this.prestigePending) return;
                const now = Date.now();
                GENERATORS_DATA.forEach(g => {
                    const btn = document.getElementById(`btn-${g.id}`);
                    const cost = this.getGenCost(g.id);
                    btn.disabled = this.state.influence < cost;
                    if (this.state.influence < cost) btn.classList.add('opacity-50');
                    else btn.classList.remove('opacity-50');
                    
                    const activeMgrId = this.state.activeManagers[g.id];
                    if (!activeMgrId && this.state.generators[g.id] > 0) {
                        if (this.state.progress[g.id] <= 0) {
                             if (!this.manualUsageTrackers[g.id]) {
                                 this.manualUsageTrackers[g.id] = now;
                             } else if (now - this.manualUsageTrackers[g.id] > 3000) {
                                 const card = document.getElementById(`card-${g.id}`);
                                 const iconContainer = card.querySelector('.ring-container');
                                 if (!iconContainer.classList.contains('animate-wiggle')) {
                                     iconContainer.classList.add('animate-wiggle');
                                 }
                             }
                        } else {
                             this.manualUsageTrackers[g.id] = null;
                             const card = document.getElementById(`card-${g.id}`);
                             const iconContainer = card.querySelector('.ring-container');
                             iconContainer.classList.remove('animate-wiggle');
                        }
                    }
                    if (!activeMgrId) {
                        const firstMgr = MANAGER_OPTIONS[g.id][0];
                        const card = document.getElementById(`card-${g.id}`);
                        const lock = card.querySelector('.manager-lock');
                        const mgrBtn = card.querySelector('.manager-btn');
                        const affordable = this.state.influence >= firstMgr.cost;
                        if (affordable) {
                            if (!lock.classList.contains('hidden') && !lock.classList.contains('lock-exploding')) {
                                lock.classList.add('lock-exploding');
                                setTimeout(() => {
                                    lock.classList.add('hidden');
                                    lock.classList.remove('lock-exploding');
                                    mgrBtn.classList.remove('manager-grayscale');
                                }, 750);
                            }
                            if (!this.affordableTrackers[g.id]) {
                                this.affordableTrackers[g.id] = now; 
                            } else if (now - this.affordableTrackers[g.id] > 3000) {
                                if (!mgrBtn.classList.contains('animate-wiggle')) {
                                    mgrBtn.classList.add('animate-wiggle');
                                }
                            }
                        } else {
                            this.affordableTrackers[g.id] = null;
                            mgrBtn.classList.remove('animate-wiggle');
                        }
                    } else {
                        const mgrBtn = document.getElementById(`card-${g.id}`).querySelector('.manager-btn');
                        mgrBtn.classList.remove('animate-wiggle');
                        this.affordableTrackers[g.id] = null;
                    }
                    if (this.state.generators[g.id] === 0) {
                        const firstCost = this.getGenCost(g.id);
                        if (this.state.influence >= firstCost) {
                             if (!this.buyButtonPulseTrackers[g.id]) {
                                 this.buyButtonPulseTrackers[g.id] = now;
                             } else if (now - this.buyButtonPulseTrackers[g.id] > 5000) {
                                 if (!btn.classList.contains('animate-glow')) {
                                     btn.classList.add('animate-glow');
                                 }
                             }
                        } else {
                             this.buyButtonPulseTrackers[g.id] = null;
                             btn.classList.remove('animate-glow');
                        }
                    } else {
                        this.buyButtonPulseTrackers[g.id] = null;
                        btn.classList.remove('animate-glow');
                    }
                });
            }
            renderGenerators() {
                const container = document.getElementById('generator-container');
                const tmpl = document.getElementById('generator-template');
                container.innerHTML = '';
                GENERATORS_DATA.forEach(g => {
                    const clone = tmpl.content.cloneNode(true);
                    const card = clone.querySelector('div');
                    card.id = `card-${g.id}`;
                    const triggerArea = card.querySelector('.manual-trigger-area');
                    triggerArea.classList.add('cursor-pointer-active');
                    triggerArea.onclick = () => this.activateGenerator(g.id);
                    
                    card.querySelector('.emoji').innerText = g.icon;
                    card.querySelector('.name').innerText = g.name;
                    const buyBtn = card.querySelector('.buy-btn');
                    buyBtn.id = `btn-${g.id}`;
                    buyBtn.addEventListener('click', (e) => this.buyGenerator(g.id, e));
                    card.querySelector('.manager-btn').onclick = (e) => { e.stopPropagation(); this.openManagerModal(g.id); };
                    container.appendChild(clone);
                    this.updateCardUI(g.id);
                });
            }
            updateCardUI(id) {
                const card = document.getElementById(`card-${id}`);
                if(!card) return;
                const count = this.state.generators[id];
                const cost = this.getGenCost(id);
                const costText = cost === 0 ? "FREE!" : formatNumber(cost);
                card.querySelector('.cost').innerText = costText;
                card.querySelector('.count').innerText = count;
                card.querySelector('.revenue').innerText = "+" + formatNumber(this.getGenRevenue(id));
                const unhappiness = this.getGenUnhappiness(id);
                card.querySelector('.unhappiness-gen span:first-child').innerText = "+" + formatUnhappiness(unhappiness);
                const nextMile = this.getNextMilestone(id);
                const prevMile = this.getPrevMilestone(id);
                let pct = 0;
                if (nextMile > 0) pct = Math.min(100, ((count - prevMile) / (nextMile - prevMile)) * 100);
                card.querySelector('.next-bonus-text').innerText = `Next x2 at ${nextMile}`;
                card.querySelector('.icon-progress-ring').style.background = `conic-gradient(var(--ring-fill) ${(pct/100)*360}deg, transparent 0deg)`;
                const activeMgrId = this.state.activeManagers[id];
                const mgrBtn = card.querySelector('.manager-btn');
                const mgrLabel = card.querySelector('.manager-label');
                const mgrImg = card.querySelector('.manager-img');
                const lock = mgrBtn.querySelector('.manager-lock');
                if (activeMgrId) {
                    const opts = MANAGER_OPTIONS[id];
                    const activeMgr = opts.find(m => m.id === activeMgrId);
                    const lvl = this.state.managerLevels[activeMgrId] || 1;
                    mgrBtn.classList.remove('manager-grayscale');
                    lock.classList.add('hidden');
                    mgrImg.src = activeMgr.img;
                    mgrLabel.innerText = "x" + (activeMgr.mult * Math.pow(2, lvl-1));
                    mgrLabel.classList.replace('bg-gray-700', 'bg-green-600');
                } else {
                    const defaultMgr = MANAGER_OPTIONS[id][0];
                    const affordable = this.state.influence >= defaultMgr.cost;
                    if (affordable) {
                         mgrBtn.classList.remove('manager-grayscale');
                         if(!lock.classList.contains('lock-exploding')) lock.classList.add('hidden');
                    } else {
                         mgrBtn.classList.add('manager-grayscale');
                         if(!lock.classList.contains('lock-exploding')) lock.classList.remove('hidden');
                    }
                    mgrImg.src = defaultMgr.img;
                    mgrLabel.innerText = "Hire";
                    mgrLabel.classList.replace('bg-green-600', 'bg-gray-700');
                }
            }
            triggerBadge(id, multiplierVal) {
                const card = document.getElementById(`card-${id}`);
                if(card) {
                    const badge = card.querySelector('.multiplier-badge');
                    badge.innerText = 'x' + multiplierVal;
                    badge.classList.remove('badge-visible');
                    badge.classList.add('badge-hidden');
                    void badge.offsetWidth; 
                    badge.classList.remove('badge-hidden');
                    badge.classList.add('badge-visible');
                    setTimeout(() => { badge.classList.remove('badge-visible'); badge.classList.add('badge-hidden'); }, 3000);
                }
            }
            handleAvatarUpload(e) {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        this.state.customAvatar = evt.target.result;
                        document.getElementById('avatar-img').src = this.state.customAvatar;
                        this.saveGame();
                        this.showToast('New Leader Uploaded!');
                    };
                    reader.readAsDataURL(file);
                }
            }
            spawnFloatText(x, y, txt) {
                const el = document.createElement('div');
                el.className = 'floating-text';
                el.innerText = txt;
                el.style.left = (x - 20) + 'px';
                el.style.top = (y - 40) + 'px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }
            showToast(msg) {
                const con = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = 'bg-gray-800 text-white text-xs font-bold px-4 py-2 rounded shadow-lg text-center border-2 border-gray-600';
                el.innerText = msg;
                con.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
            saveGame() {
                try { localStorage.setItem('idleSocialistV9', JSON.stringify(this.state)); } 
                catch(e) { const noImg = {...this.state, customAvatar: null}; localStorage.setItem('idleSocialistV9', JSON.stringify(noImg)); }
            }
            loadGame() {
                const save = localStorage.getItem('idleSocialistV9') || localStorage.getItem('idleSocialistV8');
                if(save) {
                    try {
                        const d = JSON.parse(save);
                        this.state = {...this.state, ...d};
                        if (this.state.generators['workshop'] !== undefined) {
                            this.state.generators['social_union'] = this.state.generators['workshop'];
                            delete this.state.generators['workshop'];
                        }
                        if (!this.state.managerLevels) this.state.managerLevels = {};
                        Object.values(MANAGER_OPTIONS).flat().forEach(m => {
                            if(!this.state.managerLevels[m.id]) this.state.managerLevels[m.id] = 1;
                        });
                        if(this.state.theoryPoints === undefined) this.state.theoryPoints = 0;
                        if(!this.state.activeMissions) this.state.activeMissions = {};
                        if(!this.state.missionTimers) this.state.missionTimers = {};
                        if(!this.state.missionCooldowns) this.state.missionCooldowns = {};
                        if(!this.state.levelStartTime) this.state.levelStartTime = Date.now();
                        if(this.state.adBoostExpiry === undefined) this.state.adBoostExpiry = 0;
                        if(this.state.missionCount === undefined) this.state.missionCount = 0;
                        if(this.state.adSlotUnlocked === undefined) this.state.adSlotUnlocked = false;
                        
                        if(!this.state.stats) {
                            this.state.stats = {
                                taps: 0,
                                upgrades: 0,
                                managersHired: 0,
                                managersUpgraded: 0,
                                quests: 0,
                                maxCash: 0
                            };
                        }
                        if(!this.state.ownedProperties) this.state.ownedProperties = [];
                        
                        // Stimulus checks
                        if(!this.state.lastStimulusTime) this.state.lastStimulusTime = Date.now();
                        this.state.stimulusActive = false; 

                    } catch(e) { console.log('Save corrupted'); }
                } else {
                    this.state.levelStartTime = Date.now();
                }
            }
            // REPLACES THE PREVIOUS animateManagerUpgradeEffect
            animateManagerUpgradeEffect(mgrId, imgSrc, oldVal, newVal, onComplete) {
                const sourceImg = document.getElementById(`mgr-img-${mgrId}`);
                if (!sourceImg) { if(onComplete) onComplete(); return; }

                // 1. Hide original temporarily
                sourceImg.style.opacity = '0';

                // 2. Calculate Geometry for High-Res Scaling (5x)
                const startRect = sourceImg.getBoundingClientRect();
                const targetScale = 5; 
                const bigWidth = startRect.width * targetScale;
                const bigHeight = startRect.height * targetScale;

                const clone = document.createElement('img');
                clone.src = imgSrc;
                clone.className = 'flying-manager-icon';
                
                // Set physical size to the "Big" target size (High Quality)
                clone.style.width = `${bigWidth}px`;
                clone.style.height = `${bigHeight}px`;
                
                // Position anchor at top-left
                clone.style.left = `${startRect.left}px`;
                clone.style.top = `${startRect.top}px`;
                clone.style.transformOrigin = 'top left';
                
                // Scale DOWN to match the starting 1x size
                clone.style.transform = `scale(${1/targetScale})`; 
                
                document.body.appendChild(clone);

                // 3. Create Text Container
                const textContainer = document.createElement('div');
                textContainer.className = 'upgrade-text-box';
                textContainer.innerHTML = `
                    <div class="upgrade-label">Multiplier</div>
                    <div class="upgrade-value">x${oldVal.toLocaleString()}</div>
                `;
                textContainer.style.left = '50%';
                textContainer.style.top = '60%'; 
                textContainer.style.transform = 'translate(-50%, 0) scale(0.5)';
                document.body.appendChild(textContainer);

                // 4. ANIMATION SEQUENCE
                requestAnimationFrame(() => {
                    // Enable transition for the movement
                    clone.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    
                    // Calculate Center Position
                    const viewportW = window.innerWidth;
                    const viewportH = window.innerHeight;
                    const targetX = (viewportW - bigWidth) / 2;
                    const targetY = (viewportH - bigHeight) / 2;
                    const deltaX = targetX - startRect.left;
                    const deltaY = targetY - startRect.top;

                    // Move to center and scale to 1 (Actual 5x size)
                    clone.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1)`;

                    setTimeout(() => {
                        textContainer.classList.add('visible');
                        
                        // Phase 2: Smoother Count Up
                        this.animateCountUpVal(textContainer.querySelector('.upgrade-value'), oldVal, newVal);

                        // Phase 3: Return
                        // UPDATED: Increased wait time to 2500ms to match the new 2s counter
                        setTimeout(() => {
                            textContainer.classList.remove('visible');
                            
                            const currentSource = document.getElementById(`mgr-img-${mgrId}`);
                            const finalRect = currentSource ? currentSource.getBoundingClientRect() : startRect;
                            const backDeltaX = finalRect.left - startRect.left;
                            const backDeltaY = finalRect.top - startRect.top;
                            
                            // Fly back and scale down
                            clone.style.transform = `translate(${backDeltaX}px, ${backDeltaY}px) scale(${1/targetScale})`;
                            
                            setTimeout(() => {
                                if(currentSource) currentSource.style.opacity = '1';
                                clone.remove();
                                textContainer.remove();
                                if (onComplete) onComplete();
                            }, 500);

                        }, 1500); // <--- CHANGED: Increased from 1200 to 2500

                    }, 300); 
                });
            }

            // REPLACES THE PREVIOUS animateCountUpVal
            animateCountUpVal(element, start, end) {
                // Fixed duration of 2 seconds for the rolling numbers
                const duration = 500; 
                
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    
                    // Smooth ease-out for the numbers rolling
                    const ease = 1 - Math.pow(1 - progress, 4);
                    const current = Math.floor(ease * (end - start) + start);
                    
                    element.innerText = "x" + current.toLocaleString();
                    
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        // --- ANIMATION FINISH ---
                        element.innerText = "x" + end.toLocaleString();
                        
                        // 1. Apply a "Spring" transition to smooth the pop
                        // cubic-bezier(0.34, 1.56, 0.64, 1) creates a bouncy overshoot effect
                        element.style.transition = "transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.3s ease, text-shadow 0.3s ease";
                        
                        // 2. Trigger the Pop (Scale Up)
                        requestAnimationFrame(() => {
                            element.style.transform = "scale(1.5)"; // Grow to 1.5x
                            element.style.color = "#ffffff";        // Flash white
                            element.style.textShadow = "0 0 30px #ffffff"; // Strong glow
                        });
                        
                        // 3. Settle back down gently
                        setTimeout(() => {
                            element.style.transform = "scale(1)";   // Return to normal size
                            element.style.color = "#FACC15";        // Return to Gold
                            element.style.textShadow = "0 2px 0 #000";
                        }, 600); // Wait for the pop to peak before settling
                    }
                };
                window.requestAnimationFrame(step);
            }
            hardReset() {
                if(confirm("Restart the revolution?")) {
                    localStorage.removeItem('idleSocialistV9');
                    localStorage.removeItem('idleSocialistV8');
                    localStorage.removeItem('idleSocialistV7');
                    location.reload();
                }
            }
        }

        const game = new Game();
        window.onload = () => game.init();

    </script>
</body>
</html>
